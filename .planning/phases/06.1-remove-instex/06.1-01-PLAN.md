---
phase: 06.1-remove-instex
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/instex/ (DELETE)
  - internal/pages/extensions/page.go
  - internal/pages/extensions/logic.go
  - internal/app/app.go
  - data/org.frostyard.ChairLift.instex.policy (DELETE)
  - data/org.frostyard.ChairLift.instex.rules (DELETE)
  - .goreleaser.yaml
  - CONFIG.md
autonomous: true

must_haves:
  truths:
    - "Application compiles without instex package"
    - "Extensions page discover UI still works (now via updex SDK)"
    - "Extensions page install functionality still works (now via updex SDK)"
    - "No references to 'instex' remain in Go source files"
    - "PolicyKit files for instex are deleted"
    - "goreleaser doesn't reference instex policies"
  artifacts:
    - path: "internal/pages/extensions/page.go"
      provides: "Extensions page using p.client for discover/install"
      not_contains: "instex"
      contains: "p.client.Discover"
    - path: "internal/pages/extensions/logic.go"
      provides: "Client with IsDiscoverAvailable method"
      contains: "IsDiscoverAvailable"
    - path: "internal/app/app.go"
      provides: "App initialization without instex"
      not_contains: "instex"
  key_links:
    - from: "extensions/page.go"
      to: "extensions/logic.go"
      via: "p.client.Discover and p.client.Install"
      pattern: "p\\.client\\.(Discover|Install)"
    - from: "extensions/logic.go"
      to: "updex library"
      via: "c.client.Discover and c.client.Install"
      pattern: "c\\.client\\.(Discover|Install)"
---

<objective>
Migrate extensions page from instex CLI wrapper to updex SDK.

Purpose: The instex CLI tool functionality is now included in the updex SDK. The page.go currently calls instex directly for discover/install operations. The logic.go already has Client.Discover() and Client.Install() wrappers around the updex SDK. This plan migrates page.go to use those existing Client methods instead of instex.

Output: Discover and install functionality preserved, but now using updex SDK via the existing Client abstraction instead of the instex CLI.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@internal/instex/instex.go
@internal/pages/extensions/page.go
@internal/pages/extensions/logic.go
@internal/app/app.go
@.goreleaser.yaml
@CONFIG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IsDiscoverAvailable to logic.go and migrate page.go to use Client</name>
  <files>
    internal/pages/extensions/logic.go
    internal/pages/extensions/page.go
  </files>
  <action>
    **logic.go - Add availability check:**
    
    Add a new method to Client that checks if discover functionality is available.
    The updex SDK should work if systemd-sysext is available (already checked by IsAvailable()).
    
    ```go
    // IsDiscoverAvailable returns true if discover functionality is available.
    // This requires systemd-sysext to be installed.
    func (c *Client) IsDiscoverAvailable() bool {
        return IsAvailable()
    }
    ```

    **page.go - Migrate from instex to p.client:**

    1. **Remove instex import** (line 10):
       Delete: `"github.com/frostyard/chairlift/internal/instex"`

    2. **Update buildDiscoverGroup()** (line 196-199):
       Change: `if !instex.IsInstalled() {`
       To: `if !p.client.IsDiscoverAvailable() {`

    3. **Update onDiscoverClicked()** (lines 254-258):
       Change:
       ```go
       ctx, cancel := instex.DefaultContext()
       defer cancel()
       result, err := instex.Discover(ctx, url)
       ```
       To:
       ```go
       result, err := p.client.Discover(p.ctx, url)
       ```
       Note: Use p.ctx (page context) instead of creating a new one with instex.DefaultContext()

    4. **Update displayDiscoveryResults()** (line 285):
       Change signature from: `func (p *Page) displayDiscoveryResults(repoURL string, result *instex.DiscoverOutput)`
       To: `func (p *Page) displayDiscoveryResults(repoURL string, result []DiscoveredExtension)`
       
       Update the loop (line 305):
       Change: `for _, ext := range result.Extensions {`
       To: `for _, ext := range result {`

    5. **Update onInstallExtensionClicked()** (lines 356-360):
       Change:
       ```go
       ctx, cancel := instex.DefaultContext()
       defer cancel()
       err := instex.Install(ctx, repoURL, component)
       ```
       To:
       ```go
       err := p.client.Install(p.ctx, repoURL, component)
       ```
  </action>
  <verify>
    ```bash
    # Verify no instex import in page.go
    ! grep -q '"github.com/frostyard/chairlift/internal/instex"' internal/pages/extensions/page.go && echo "PASS: no instex import"
    
    # Verify client methods are used
    grep -q "p.client.Discover" internal/pages/extensions/page.go && echo "PASS: uses p.client.Discover"
    grep -q "p.client.Install" internal/pages/extensions/page.go && echo "PASS: uses p.client.Install"
    grep -q "p.client.IsDiscoverAvailable" internal/pages/extensions/page.go && echo "PASS: uses p.client.IsDiscoverAvailable"
    
    # Verify logic.go has the new method
    grep -q "func (c \*Client) IsDiscoverAvailable" internal/pages/extensions/logic.go && echo "PASS: IsDiscoverAvailable exists"
    ```
  </verify>
  <done>
    - page.go no longer imports instex
    - page.go uses p.client.Discover() instead of instex.Discover()
    - page.go uses p.client.Install() instead of instex.Install()
    - page.go uses p.client.IsDiscoverAvailable() instead of instex.IsInstalled()
    - logic.go has IsDiscoverAvailable() method
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete instex package, PolicyKit files, and clean up remaining references</name>
  <files>
    internal/instex/ (DELETE entire directory)
    internal/app/app.go
    data/org.frostyard.ChairLift.instex.policy (DELETE)
    data/org.frostyard.ChairLift.instex.rules (DELETE)
    .goreleaser.yaml
    CONFIG.md
  </files>
  <action>
    **Delete instex package and PolicyKit files:**
    
    1. Delete `internal/instex/` directory
    2. Delete `data/org.frostyard.ChairLift.instex.policy`
    3. Delete `data/org.frostyard.ChairLift.instex.rules`

    **app.go - Remove instex references:**
    
    - Remove import: `"github.com/frostyard/chairlift/internal/instex"` (line 8)
    - Remove line: `instex.SetDryRun(true)` (line 43)

    **.goreleaser.yaml - Remove instex PolicyKit entries (lines 122-126):**
    
    Delete these lines:
    ```yaml
    # PolicyKit policy and rules for instex
    - src: ./data/org.frostyard.ChairLift.instex.policy
      dst: /usr/share/polkit-1/actions/org.frostyard.ChairLift.instex.policy
    - src: ./data/org.frostyard.ChairLift.instex.rules
      dst: /usr/share/polkit-1/rules.d/org.frostyard.ChairLift.instex.rules
    ```

    **CONFIG.md - Update documentation (line 69):**
    
    Change: `- \`discover_group\`: Discover and install extensions from remote repositories (requires \`instex\` command)`
    To: `- \`discover_group\`: Discover and install extensions from remote repositories`
    
    (Remove the "(requires `instex` command)" part since it now uses the updex SDK)
  </action>
  <verify>
    ```bash
    # Verify deletions
    [ ! -d internal/instex ] && echo "PASS: instex directory deleted"
    [ ! -f data/org.frostyard.ChairLift.instex.policy ] && echo "PASS: instex policy deleted"
    [ ! -f data/org.frostyard.ChairLift.instex.rules ] && echo "PASS: instex rules deleted"
    
    # Verify no instex in app.go
    ! grep -q "instex" internal/app/app.go && echo "PASS: app.go clean"
    
    # Verify goreleaser clean
    ! grep -q "instex" .goreleaser.yaml && echo "PASS: goreleaser clean"
    
    # Verify CONFIG.md updated (discover_group exists but no instex mention)
    grep -q "discover_group" CONFIG.md && ! grep -q "instex" CONFIG.md && echo "PASS: CONFIG.md updated"
    
    # Verify build succeeds
    go build ./... && echo "PASS: build succeeds"
    ```
  </verify>
  <done>
    - internal/instex/ directory deleted
    - PolicyKit files for instex deleted
    - app.go has no instex references
    - goreleaser.yaml has no instex entries
    - CONFIG.md documents discover_group without instex requirement
    - Application builds successfully
  </done>
</task>

</tasks>

<verification>
```bash
# Full verification suite
set -e

# 1. No instex directory
[ ! -d internal/instex ] && echo "PASS: instex directory deleted"

# 2. No instex PolicyKit files
[ ! -f data/org.frostyard.ChairLift.instex.policy ] && echo "PASS: instex policy deleted"
[ ! -f data/org.frostyard.ChairLift.instex.rules ] && echo "PASS: instex rules deleted"

# 3. No instex in Go source
! grep -rq "instex" internal/ --include="*.go" && echo "PASS: no instex in Go source"

# 4. Build succeeds
go build ./... && echo "PASS: build succeeds"

# 5. No instex in goreleaser
! grep -q "instex" .goreleaser.yaml && echo "PASS: goreleaser clean"

# 6. Discover functionality uses Client
grep -q "p.client.Discover" internal/pages/extensions/page.go && echo "PASS: discover via client"
grep -q "p.client.Install" internal/pages/extensions/page.go && echo "PASS: install via client"

echo "All verifications passed"
```
</verification>

<success_criteria>
1. Application compiles without instex package
2. Extensions page discover UI works using updex SDK via Client
3. Extensions page install functionality works using updex SDK via Client
4. Zero references to "instex" in any Go source file
5. instex PolicyKit files deleted from data/
6. goreleaser.yaml doesn't reference instex policies
7. CONFIG.md documents discover_group without requiring instex
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-remove-instex/06.1-01-SUMMARY.md`
</output>
