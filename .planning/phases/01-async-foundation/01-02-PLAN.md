---
phase: 01-async-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/views/userhome.go
autonomous: true

must_haves:
  truths:
    - "All 70+ runOnMainThread calls in userhome.go use async.RunOnMain instead"
    - "Local runOnMainThread function and callback registry are removed from userhome.go"
    - "Application compiles and runOnMainThread is not defined locally"
  artifacts:
    - path: "internal/views/userhome.go"
      provides: "Page views using centralized async.RunOnMain"
      contains: "async.RunOnMain"
  key_links:
    - from: "internal/views/userhome.go"
      to: "internal/async"
      via: "import and function call"
      pattern: 'async\.RunOnMain'
---

<objective>
Migrate userhome.go from local runOnMainThread() to the shared async.RunOnMain() function.

Purpose: Eliminate the local implementation in userhome.go and establish the async package as the single source of truth for thread-safe GTK updates. This addresses INFR-03 (consolidate runOnMainThread) and INFR-04 (callback registry prevents GC).

Output: userhome.go no longer contains its own runOnMainThread implementation; all ~70 call sites use async.RunOnMain().
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-async-foundation/01-CONTEXT.md
@.planning/phases/01-async-foundation/01-01-SUMMARY.md
@internal/async/scheduler.go
@internal/views/userhome.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove local runOnMainThread and add async import</name>
  <files>internal/views/userhome.go</files>
  <action>
1. Add import for the new async package:
   ```go
   "github.com/frostyard/chairlift/internal/async"
   ```
   Place it in the internal project packages section (after config, before pm or similar).

2. Delete the local runOnMainThread implementation (lines 28-55 approximately):
   - Delete the comment `// idleCallbackRegistry stores callbacks to prevent GC collection`
   - Delete the var block with idleCallbackMu, idleCallbacks, idleCallbackID
   - Delete the entire runOnMainThread function

3. Do NOT replace call sites yet - Task 2 handles that.

After this task, the file will not compile (undefined: runOnMainThread). That's expected.
  </action>
  <verify>
- Import for async package is present
- No local runOnMainThread function definition exists
- No local idleCallback* variables exist
- File does NOT compile yet (expected - call sites still reference old name)
  </verify>
  <done>
- async import added to userhome.go
- Local callback registry code completely removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all runOnMainThread calls with async.RunOnMain</name>
  <files>internal/views/userhome.go</files>
  <action>
Replace ALL occurrences of `runOnMainThread(` with `async.RunOnMain(` in userhome.go.

There are approximately 70+ call sites based on the grep results. Use find-and-replace:
- Search: `runOnMainThread(`
- Replace: `async.RunOnMain(`

This is a mechanical replacement - the function signature is identical (func()), so no other changes needed.

After replacement, verify the file compiles:
```bash
go build ./internal/views/...
```

If there are any compilation errors, they indicate:
- Missing import (fix in Task 1)
- Typo in replacement
- Edge case needing manual attention

Do NOT modify the logic inside any callbacks - only the function name changes.
  </action>
  <verify>
- `go build ./internal/views/...` succeeds
- `grep -c "runOnMainThread" internal/views/userhome.go` returns 0
- `grep -c "async.RunOnMain" internal/views/userhome.go` returns ~70+ matches
  </verify>
  <done>
- All call sites migrated to async.RunOnMain
- userhome.go compiles successfully
- No references to runOnMainThread remain in userhome.go
  </done>
</task>

<task type="auto">
  <name>Task 3: Add UserError to key error display points</name>
  <files>internal/views/userhome.go</files>
  <action>
Add UserError usage at 3-5 key error points to establish the pattern. Focus on high-visibility operations:

1. Find an NBC update error handler and wrap the error:
   ```go
   // Before:
   uh.toastAdder.ShowErrorToast(fmt.Sprintf("Error updating: %v", err))
   
   // After:
   userErr := async.NewUserErrorWithHint(
       "Couldn't update system",
       "Check your internet connection and try again",
       err,
   )
   uh.toastAdder.ShowErrorToast(userErr.FormatForUser())
   log.Printf("Update error details: %v", err)
   ```

2. Find a Flatpak install/remove error and apply the same pattern

3. Find a Homebrew operation error and apply the pattern

4. Find an extension/updex error and apply the pattern

Pick obvious, user-facing errors. Use CONTEXT.md tone:
- "Couldn't install {name}" not "Failed to install" or "Installation failed"
- Add hints only when actionable (network issues -> "check connection", permission -> "try again")
- Log the technical error, show the friendly message

Do NOT refactor all error handling - just establish the pattern at 3-5 visible points.
Future phases will systematically apply this across the codebase.
  </action>
  <verify>
- `go build ./internal/views/...` succeeds
- grep shows async.NewUserError or async.NewUserErrorWithHint usage in userhome.go
- At least 3 error handlers updated to use UserError pattern
  </verify>
  <done>
- 3-5 key error handlers use async.UserError pattern
- User-friendly messages follow CONTEXT.md tone ("Couldn't", actionable hints)
- Technical errors are logged, not shown to users
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification:
   ```bash
   go build ./...
   ```

2. Grep verification:
   ```bash
   # Should return 0
   grep -c "runOnMainThread" internal/views/userhome.go || echo "Good - no matches"
   
   # Should return 70+
   grep -c "async.RunOnMain" internal/views/userhome.go
   
   # Should return 3+
   grep -c "async.NewUserError" internal/views/userhome.go
   ```

3. Vet verification:
   ```bash
   go vet ./internal/views/...
   ```

4. Run application (if possible):
   ```bash
   go run ./cmd/chairlift --dry-run
   ```
   Verify it starts without crashes.
</verification>

<success_criteria>
- [ ] No local runOnMainThread function in userhome.go
- [ ] No local idleCallback* variables in userhome.go
- [ ] Import for internal/async present
- [ ] All ~70 call sites use async.RunOnMain
- [ ] 3-5 error handlers use async.UserError pattern
- [ ] `go build ./...` passes
- [ ] `go vet ./internal/views/...` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-async-foundation/01-02-SUMMARY.md` using the summary template.
</output>
