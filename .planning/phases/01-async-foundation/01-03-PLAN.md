---
phase: 01-async-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/pm/wrapper.go
autonomous: true

must_haves:
  truths:
    - "All runOnMainThread calls in pm/wrapper.go use async.RunOnMain instead"
    - "Local runOnMainThread function is removed from wrapper.go"
    - "Package manager errors use UserError for user-facing messages"
  artifacts:
    - path: "internal/pm/wrapper.go"
      provides: "Package manager wrapper using centralized async.RunOnMain"
      contains: "async.RunOnMain"
  key_links:
    - from: "internal/pm/wrapper.go"
      to: "internal/async"
      via: "import and function call"
      pattern: 'async\.RunOnMain'
---

<objective>
Migrate pm/wrapper.go from local runOnMainThread() to the shared async.RunOnMain() and add UserError integration.

Purpose: Complete the consolidation of runOnMainThread implementations. The wrapper.go version lacks the callback registry (note lines 411-418 use naked glib.IdleAdd), making it potentially vulnerable to GC issues. This plan replaces it with the robust async.RunOnMain implementation.

Output: wrapper.go uses async.RunOnMain() for all GTK main thread callbacks and key errors are wrapped in UserError.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-async-foundation/01-CONTEXT.md
@.planning/phases/01-async-foundation/01-01-SUMMARY.md
@internal/async/scheduler.go
@internal/async/errors.go
@internal/pm/wrapper.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace local runOnMainThread with async.RunOnMain</name>
  <files>internal/pm/wrapper.go</files>
  <action>
1. Add import for the new async package:
   ```go
   "github.com/frostyard/chairlift/internal/async"
   ```
   Place it in the internal project packages section.

2. Delete the local runOnMainThread function (lines 409-418 approximately):
   - Delete the comment `// runOnMainThread schedules a function to run on the GTK main thread`
   - Delete the comment `// This mirrors the pattern used in views/userhome.go`
   - Delete the entire runOnMainThread function body

3. Replace all 5 call sites of `runOnMainThread(` with `async.RunOnMain(`:
   - Line ~358: runOnMainThread in progress callback
   - Line ~373: runOnMainThread in progress callback  
   - Line ~388: runOnMainThread in progress callback
   - Line ~403: runOnMainThread in progress callback

4. Verify the file compiles:
   ```bash
   go build ./internal/pm/...
   ```

Note: The wrapper.go implementation used naked glib.IdleAdd without the callback registry.
By switching to async.RunOnMain, we get the GC-safe callback registry automatically.
  </action>
  <verify>
- Import for async package is present
- No local runOnMainThread function definition exists
- `go build ./internal/pm/...` succeeds
- `grep -c "runOnMainThread" internal/pm/wrapper.go` returns 0
  </verify>
  <done>
- All call sites migrated to async.RunOnMain
- Local runOnMainThread function removed
- wrapper.go compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add UserError to package manager operation errors</name>
  <files>internal/pm/wrapper.go</files>
  <action>
Add UserError usage at key error return points. Focus on errors that bubble up to users.

Review the package and identify main error-producing functions:
- Install operations (Flatpak, Snap, Homebrew)
- Remove/uninstall operations
- Update operations
- Availability check errors (if exposed to users)

For each identified error point that users might see:
```go
// Before:
return fmt.Errorf("failed to install Flatpak: %w", err)

// After:
return async.NewUserErrorWithHint(
    fmt.Sprintf("Couldn't install %s", name),
    "The remote may be unavailable. Check your internet connection",
    err,
)
```

Follow CONTEXT.md tone:
- "Couldn't install {name}" not "Failed to install"
- Add hints when actionable
- Keep summaries under ~50 characters

Target 3-5 key error points:
1. Flatpak install error
2. Flatpak remove error  
3. Snap install error
4. Homebrew install error
5. One update-related error

Do NOT convert every error - just establish the pattern at visible user-facing points.
Internal errors that are caught and handled elsewhere can remain as-is.
  </action>
  <verify>
- `go build ./internal/pm/...` succeeds
- grep shows async.NewUserError or async.NewUserErrorWithHint usage
- At least 3 error points use UserError pattern
  </verify>
  <done>
- 3-5 key error points use async.UserError pattern
- User-friendly messages follow CONTEXT.md tone
- Package compiles without errors
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification:
   ```bash
   go build ./...
   ```

2. Grep verification:
   ```bash
   # Should return 0
   grep -c "runOnMainThread" internal/pm/wrapper.go || echo "Good - no matches"
   
   # Should return 4-5
   grep -c "async.RunOnMain" internal/pm/wrapper.go
   
   # Should return 3+
   grep -c "async.NewUserError" internal/pm/wrapper.go
   ```

3. Vet verification:
   ```bash
   go vet ./internal/pm/...
   ```

4. Full build:
   ```bash
   go build ./cmd/chairlift
   ```
</verification>

<success_criteria>
- [ ] No local runOnMainThread function in wrapper.go
- [ ] Import for internal/async present
- [ ] All ~5 call sites use async.RunOnMain
- [ ] 3-5 error points use async.UserError pattern
- [ ] `go build ./...` passes
- [ ] `go vet ./internal/pm/...` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-async-foundation/01-03-SUMMARY.md` using the summary template.
</output>
