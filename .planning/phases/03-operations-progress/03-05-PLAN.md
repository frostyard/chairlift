---
phase: 03-operations-progress
plan: 05
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - internal/views/userhome.go
autonomous: false

must_haves:
  truths:
    - "At least one operation uses the new operations tracking"
    - "Operation appears in popover while running"
    - "Cancellation works with confirmation dialog"
  artifacts:
    - path: "internal/views/userhome.go"
      provides: "Example migration of async operation to use tracking"
      contains: "StartTrackedOperation"
  key_links:
    - from: "internal/views/userhome.go"
      to: "internal/widgets/action_button.go"
      via: "StartTrackedOperation call"
      pattern: "StartTrackedOperation"
---

<objective>
Validate the operations system by migrating one async operation in userhome.go to use tracking.

Purpose: Prove the integration works end-to-end before Phase 4+ migrates remaining operations.
Output: One operation (preferably a visible one like install/update) uses StartTrackedOperation and appears in popover.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-operations-progress/03-CONTEXT.md
@.planning/phases/03-operations-progress/03-04-SUMMARY.md

@internal/views/userhome.go
@internal/widgets/action_button.go
@internal/operations/registry.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate one operation to use tracking</name>
  <files>
    internal/views/userhome.go
  </files>
  <action>
Find a suitable operation in userhome.go to migrate. Good candidates:
- NBC update check (if it uses ActionButton)
- An install button 
- An update button

Migrate the chosen operation to use StartTrackedOperation:

Before (typical pattern):
```go
btn.OnClicked(func(done func()) {
    go func() {
        err := doSomeWork()
        async.RunOnMain(func() {
            done()
            if err != nil {
                showError(err)
            }
        })
    }()
})
```

After (with tracking):
```go
// Assume btn is *widgets.ActionButton
var btn *widgets.ActionButton
btn = widgets.NewActionButtonWithClass("Update", "suggested-action")
clickCb := func(_ gtk.Button) {
    op, done := btn.StartTrackedOperation(
        "Updating...",           // workingLabel
        "Check for Updates",     // name for registry
        operations.CategoryUpdate,
        true,                    // cancellable
    )
    
    go func() {
        // Use context for cancellation
        ctx := context.Background()
        if op.CancelFunc != nil {
            var cancel context.CancelFunc
            ctx, cancel = context.WithCancel(ctx)
            op.CancelFunc = cancel
        }
        
        err := doSomeWork(ctx)
        
        async.RunOnMain(func() {
            done()
            op.Complete(err)
            if err != nil && err != context.Canceled {
                showError(err)
            }
        })
    }()
}
btn.Button.ConnectClicked(&clickCb)
```

If the operation doesn't currently accept context, that's OK for this validation - just don't mark it cancellable:
```go
op, done := btn.StartTrackedOperation(
    "Checking...",
    "Check NBC Status",
    operations.CategoryLoading,
    false,  // not cancellable for now
)
```

The key validation points:
1. Operation appears in popover while running
2. Badge shows count = 1
3. Operation moves to history when complete
4. If cancellable: cancel button works with confirmation dialog

Add necessary imports:
```go
import "github.com/frostyard/chairlift/internal/operations"
```
  </action>
  <verify>
`go build ./...` succeeds
  </verify>
  <done>
One operation in userhome.go uses StartTrackedOperation and operation appears in popover
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Operations tracking system with:
1. Operations package (registry, types, popover, dialogs)
2. ProgressRow widget
3. Header button integration
4. One migrated operation in userhome.go
  </what-built>
  <how-to-verify>
1. Run the application: `go run ./cmd/chairlift`
2. Look for operations button in sidebar header (sync icon, left of hamburger menu)
3. Click the operations button - should show popover with "Active" and "History" tabs
4. Trigger the migrated operation (e.g., click Update button)
5. While running:
   - Badge should appear on operations button showing "1"
   - Operation should appear in Active tab with name and status
   - If cancellable: Cancel button should be visible
6. After completion:
   - Badge should disappear (or show 0)
   - Operation should appear in History tab with outcome and duration
7. If cancellable, test cancellation:
   - Click Cancel button
   - Confirmation dialog should appear
   - Clicking "Cancel Operation" should cancel and show in history as cancelled
  </how-to-verify>
  <resume-signal>Type "approved" if operations tracking works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `go build ./...` succeeds
- [ ] Operations button visible in header
- [ ] Clicking operations button opens popover with Active/History tabs
- [ ] Migrated operation appears in popover while running
- [ ] Badge shows correct count
- [ ] Operation appears in history after completion
- [ ] If cancellable: confirmation dialog works, cancellation succeeds
</verification>

<success_criteria>
- Full operations tracking system works end-to-end
- User can see ongoing operations in popover
- User can see operation history
- If cancellable: cancellation works with confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/03-operations-progress/03-05-SUMMARY.md`
</output>
