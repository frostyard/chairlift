---
phase: 03-operations-progress
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/widgets/progress_row.go
  - internal/widgets/doc.go
autonomous: true

must_haves:
  truths:
    - "ProgressRow shows spinner for short operations"
    - "ProgressRow transitions to progress bar after 30 seconds"
    - "ProgressRow shows cancel button for cancellable operations"
  artifacts:
    - path: "internal/widgets/progress_row.go"
      provides: "ActionRow with spinner/progress bar and optional cancel"
      exports: ["ProgressRow", "NewProgressRow"]
      min_lines: 80
  key_links:
    - from: "internal/widgets/progress_row.go"
      to: "internal/operations/operation.go"
      via: "Updates from Operation state changes"
      pattern: "operations\\.Operation"
---

<objective>
Create ProgressRow widget that displays operation progress inline with spinner-to-progress-bar transition.

Purpose: Per CONTEXT.md, progress appears inline next to triggering button/row as primary location. This widget provides that inline display.
Output: `internal/widgets/progress_row.go` with ProgressRow widget.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-operations-progress/03-CONTEXT.md
@.planning/phases/03-operations-progress/03-RESEARCH.md
@.planning/phases/03-operations-progress/03-01-SUMMARY.md

@internal/widgets/doc.go
@internal/widgets/loading_row.go
@internal/operations/operation.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProgressRow widget</name>
  <files>
    internal/widgets/progress_row.go
  </files>
  <action>
Create `internal/widgets/progress_row.go` following the established widget pattern (composition with public GTK widget field):

```go
// ProgressRow displays operation progress with spinner or progress bar.
// Short operations show a spinner, operations > 30s transition to progress bar.
type ProgressRow struct {
    Row         *adw.ActionRow
    spinner     *gtk.Spinner
    progressBar *gtk.ProgressBar
    cancelBtn   *gtk.Button
    
    startedAt   time.Time
    showingBar  bool  // true if progress bar is visible (after 30s)
}
```

Implement:
- `NewProgressRow(title string, cancellable bool, onCancel func()) *ProgressRow`
  - Creates ActionRow with title
  - Adds spinner as suffix (started)
  - Creates progress bar (hidden initially)
  - If cancellable, adds cancel button with "Cancel" label as suffix
  - Cancel button calls onCancel callback (which should show confirmation dialog)
  - Records startedAt time

- `(pr *ProgressRow) UpdateProgress(progress float64, message string)`
  - Updates subtitle with message
  - If progress >= 0 and (elapsed > 30s OR showingBar is already true):
    - Hide spinner, show progress bar
    - Set progress bar fraction
    - Set showingBar = true
  - If progress < 0 (indeterminate) and showingBar:
    - Use progressBar.Pulse() for animation

- `(pr *ProgressRow) Stop()`
  - Stops spinner
  - Hides both spinner and progress bar
  - Removes cancel button if present

Progress bar styling per RESEARCH.md:
```go
progressBar := gtk.NewProgressBar()
progressBar.SetHexpand(true)
progressBar.SetShowText(true)  // Show percentage
```

Cancel button styling:
```go
cancelBtn := gtk.NewButtonWithLabel("Cancel")
cancelBtn.SetValign(gtk.AlignCenterValue)
cancelBtn.AddCssClass("flat")  // Flat button style in row
```
  </action>
  <verify>
`go build ./internal/widgets/...` succeeds
  </verify>
  <done>
ProgressRow widget exists with spinner, progress bar, optional cancel button. Transitions from spinner to progress bar after 30s of operation time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update widgets package documentation</name>
  <files>
    internal/widgets/doc.go
  </files>
  <action>
Update `internal/widgets/doc.go` to document ProgressRow:

Add to the widget list section:
- ProgressRow: ActionRow with spinner/progress bar for inline operation progress

Add usage example in the examples section showing:
1. Creating a ProgressRow for a cancellable operation
2. Updating progress from a goroutine via async.RunOnMain
3. Calling Stop() when operation completes

Ensure threading warnings are present (all methods must be called from GTK main thread).
  </action>
  <verify>
`go build ./internal/widgets/...` succeeds
  </verify>
  <done>
widgets/doc.go includes ProgressRow documentation with usage example
  </done>
</task>

</tasks>

<verification>
- [ ] `go build ./internal/widgets/...` succeeds
- [ ] ProgressRow has spinner that starts automatically
- [ ] ProgressRow has hidden progress bar that appears after 30s
- [ ] ProgressRow has optional cancel button based on constructor parameter
- [ ] UpdateProgress updates subtitle and transitions to progress bar when appropriate
- [ ] Stop() cleans up spinner/progress bar/cancel button
</verification>

<success_criteria>
- ProgressRow widget compiles and follows established widget patterns
- Spinner-to-progress-bar transition logic is implemented
- Cancel button appears for cancellable operations
- Documentation updated in doc.go
</success_criteria>

<output>
After completion, create `.planning/phases/03-operations-progress/03-02-SUMMARY.md`
</output>
