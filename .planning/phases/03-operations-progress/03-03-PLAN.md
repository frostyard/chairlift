---
phase: 03-operations-progress
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/operations/dialogs.go
  - internal/operations/popover.go
autonomous: true

must_haves:
  truths:
    - "Cancellation shows confirmation dialog before proceeding"
    - "Operations popover shows grouped active operations"
    - "Operations popover has separate history tab"
  artifacts:
    - path: "internal/operations/dialogs.go"
      provides: "Cancel confirmation dialog using AdwAlertDialog"
      exports: ["ShowCancelConfirmation"]
      min_lines: 30
    - path: "internal/operations/popover.go"
      provides: "Header popover UI with active/history tabs"
      exports: ["BuildOperationsButton"]
      min_lines: 100
  key_links:
    - from: "internal/operations/popover.go"
      to: "internal/operations/registry.go"
      via: "AddListener for real-time updates"
      pattern: "AddListener"
    - from: "internal/operations/dialogs.go"
      to: "adw.AlertDialog"
      via: "AdwAlertDialog for confirmation"
      pattern: "adw\\.NewAlertDialog"
---

<objective>
Create the operations popover UI and cancellation confirmation dialog.

Purpose: Per CONTEXT.md, users see all ongoing operations in a header popover with badge count, and cancellation requires confirmation.
Output: `internal/operations/dialogs.go` and `internal/operations/popover.go`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-operations-progress/03-CONTEXT.md
@.planning/phases/03-operations-progress/03-RESEARCH.md
@.planning/phases/03-operations-progress/03-01-SUMMARY.md

@internal/operations/registry.go
@internal/operations/operation.go
@internal/window/window.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cancellation confirmation dialog</name>
  <files>
    internal/operations/dialogs.go
  </files>
  <action>
Create `internal/operations/dialogs.go` with:

```go
// ShowCancelConfirmation shows a confirmation dialog before cancelling an operation.
// Per CONTEXT.md: cancellation always requires confirmation dialog.
//
// Parameters:
//   - window: Parent window for the dialog
//   - opName: Name of the operation being cancelled (shown in dialog body)
//   - onConfirm: Called if user confirms cancellation
//
// Must be called from the GTK main thread.
func ShowCancelConfirmation(window *gtk.Window, opName string, onConfirm func())
```

Implementation using AdwAlertDialog per RESEARCH.md:
```go
dialog := adw.NewAlertDialog("Cancel Operation?", "")
dialog.SetBody(fmt.Sprintf("This will cancel \"%s\". This action cannot be undone.", opName))

dialog.AddResponse("continue", "_Continue")
dialog.AddResponse("cancel", "_Cancel Operation")

dialog.SetResponseAppearance("cancel", adw.ResponseDestructiveValue)
dialog.SetDefaultResponse("continue")
dialog.SetCloseResponse("continue")

responseCb := func(d adw.AlertDialog, response string) {
    if response == "cancel" {
        onConfirm()
    }
}
dialog.ConnectResponse(&responseCb)

dialog.Present(&window.Widget)
```

Note: The onConfirm callback should:
1. Call operation.Cancel()
2. Show toast notification "Cancelled" (caller handles this)
  </action>
  <verify>
`go build ./internal/operations/...` succeeds
  </verify>
  <done>
ShowCancelConfirmation function exists using AdwAlertDialog with Continue/Cancel responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Create operations popover UI</name>
  <files>
    internal/operations/popover.go
  </files>
  <action>
Create `internal/operations/popover.go` with:

```go
// OperationsButton is a MenuButton that shows the operations popover.
// It displays a badge when operations are active.
type OperationsButton struct {
    Button     *gtk.MenuButton
    badge      *gtk.Label  // Badge showing active count
    popover    *gtk.Popover
    activeList *gtk.ListBox
    historyList *gtk.ListBox
    emptyLabel *gtk.Label  // "No active operations"
}
```

Implement:
- `BuildOperationsButton() *OperationsButton`
  - Creates MenuButton with icon "emblem-synchronizing-symbolic"
  - Tooltip "Operations"
  - SetHasFrame(false) for flat style
  - Creates popover with content
  - Badge overlay for count (circular label, initially hidden)

Popover content structure:
```
Box (vertical)
├── adw.ViewSwitcher (title = "Active" / "History")
└── adw.ViewStack
    ├── "active" page: ScrolledWindow > ListBox (activeList)
    └── "history" page: ScrolledWindow > ListBox (historyList)
```

Active operations display:
- Group by Category (only show groups with operations)
- Each operation row shows: Name, Message, Progress (if > 0), Cancel button (if cancellable)
- Failed operations show error message and "Retry" button

History display:
- Each row shows: Name, Outcome (success/failed), Timestamp, Duration
- Use adw.ActionRow with subtitle for details

Badge update:
- Register as listener with AddListener
- On each update, recalculate ActiveCount()
- If count > 0: show badge with count, else hide badge
- Update list contents

Per CONTEXT.md:
- Only show groups that have active operations
- Failed operations stay in active list with retry option

Popover sizing:
```go
popover.SetSizeRequest(300, 400)  // Reasonable default
```

Empty state:
- When no active operations: show "No active operations" label instead of empty list
  </action>
  <verify>
`go build ./internal/operations/...` succeeds
  </verify>
  <done>
BuildOperationsButton returns OperationsButton with popover showing active/history tabs, badge updates based on ActiveCount()
  </done>
</task>

</tasks>

<verification>
- [ ] `go build ./internal/operations/...` succeeds
- [ ] ShowCancelConfirmation shows AdwAlertDialog with Continue/Cancel responses
- [ ] Cancel response has destructive appearance
- [ ] BuildOperationsButton creates MenuButton with popover
- [ ] Popover has ViewSwitcher for Active/History tabs
- [ ] Badge shows count when operations are active
- [ ] OperationsButton registers as listener for real-time updates
</verification>

<success_criteria>
- Dialogs.go provides ShowCancelConfirmation with AdwAlertDialog
- Popover.go provides BuildOperationsButton with active/history tabs
- Badge updates reactively based on registry state
- UI follows GNOME HIG patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-operations-progress/03-03-SUMMARY.md`
</output>
