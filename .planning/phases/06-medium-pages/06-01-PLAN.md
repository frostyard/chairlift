---
phase: 06-medium-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pages/maintenance/logic.go
  - internal/pages/maintenance/logic_test.go
  - internal/pages/maintenance/page.go
autonomous: true

must_haves:
  truths:
    - "Maintenance page exists in its own package"
    - "Maintenance actions display with Run buttons"
    - "Maintenance action execution is tracked via operations"
    - "Failed maintenance actions offer retry"
  artifacts:
    - path: "internal/pages/maintenance/logic.go"
      provides: "Action parsing, executor interface"
      contains: "type Action struct"
    - path: "internal/pages/maintenance/logic_test.go"
      provides: "Tests for logic layer"
      contains: "func Test"
    - path: "internal/pages/maintenance/page.go"
      provides: "GTK UI for maintenance actions"
      contains: "func New"
  key_links:
    - from: "internal/pages/maintenance/page.go"
      to: "internal/operations"
      via: "operations.Start for tracking"
      pattern: "operations\\.Start"
    - from: "internal/pages/maintenance/page.go"
      to: "internal/async"
      via: "async.RunOnMain for UI updates"
      pattern: "async\\.RunOnMain"
---

<objective>
Extract Maintenance page from userhome.go into its own package following established Phase 4 patterns.

Purpose: Follows the refactoring roadmap - Maintenance page gets logic/UI separation for testability.
Output: Complete maintenance package with logic.go (pure Go, testable), logic_test.go, and page.go (GTK UI).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-medium-pages/06-CONTEXT.md
@.planning/phases/06-medium-pages/06-RESEARCH.md

# Prior patterns to follow
@internal/pages/page.go
@internal/pages/help/logic.go
@internal/pages/help/page.go
@internal/pages/system/logic.go
@internal/pages/system/page.go

# Current implementation to extract from
@internal/views/userhome.go (lines 629-743, 1085-1148)
@internal/config/config.go (ActionConfig type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create maintenance logic layer</name>
  <files>internal/pages/maintenance/logic.go, internal/pages/maintenance/logic_test.go</files>
  <action>
Create pure Go logic layer for maintenance page with NO GTK imports.

**logic.go:**
- Define `Action` struct: Title, Description (same as Script for now), Script, Sudo bool
- Define `ScriptExecutor` interface: `Execute(ctx context.Context, script string, sudo bool) error`
- Create `DefaultExecutor` that uses os/exec (pkexec for sudo scripts, direct for non-sudo)
- Create `ParseActions(cfg *config.GroupConfig) []Action` function

**logic_test.go:**
- Test ParseActions with nil config returns nil
- Test ParseActions with empty actions returns empty slice
- Test ParseActions with sample actions returns correct Action structs

**Key decisions from CONTEXT.md:**
- Mock executor interface for testability (inject executor so tests can verify without running scripts)
- Use pkexec for scripts with Sudo: true flag (matches existing instex pattern)

**Pattern from help/logic.go:** Keep logic layer minimal, just data transformation.
  </action>
  <verify>`go build ./internal/pages/maintenance/...` succeeds with no GTK imports; `go test ./internal/pages/maintenance/...` passes</verify>
  <done>logic.go has Action struct, ScriptExecutor interface, DefaultExecutor, ParseActions; logic_test.go has tests for ParseActions</done>
</task>

<task type="auto">
  <name>Task 2: Create maintenance UI layer</name>
  <files>internal/pages/maintenance/page.go</files>
  <action>
Create GTK UI layer for maintenance page following system/page.go pattern.

**Structure:**
```go
type Page struct {
    toolbarView *adw.ToolbarView
    prefsPage   *adw.PreferencesPage
    
    config    *config.Config
    toaster   pages.Toaster
    executor  ScriptExecutor
    
    ctx    context.Context
    cancel context.CancelFunc
}

func New(deps pages.Deps) *Page
func (p *Page) Widget() *adw.ToolbarView
func (p *Page) Destroy()
```

**buildUI implementation:**
1. Create ToolbarView with HeaderBar titled "Maintenance"
2. Create PreferencesPage
3. Port group creation from userhome.go buildMaintenancePage:
   - System Cleanup group: Parse actions from config, create ActionRow for each with Run button
   - Homebrew Cleanup group: Only if pm.HomebrewIsInstalled()
   - Flatpak Cleanup group: Only if pm.FlatpakIsInstalled()
   - Optimization group (placeholder)

**Action execution pattern (from RESEARCH.md Pattern 3):**
```go
func (p *Page) onActionClicked(button *gtk.Button, action *Action) {
    button.SetSensitive(false)
    button.SetLabel("Running...")
    
    op := operations.Start(action.Title, operations.CategoryMaintenance, false)
    op.RetryFunc = func() {
        p.onActionClicked(button, action)
    }
    
    go func() {
        err := p.executor.Execute(p.ctx, action.Script, action.Sudo)
        
        async.RunOnMain(func() {
            select {
            case <-p.ctx.Done():
                return // Page destroyed
            default:
            }
            
            button.SetSensitive(true)
            button.SetLabel("Run")
            op.Complete(err)
            
            if err != nil {
                p.toaster.ShowErrorToast(async.NewUserError(
                    fmt.Sprintf("Couldn't run %s", action.Title), err).FormatForUser())
            } else {
                p.toaster.ShowToast(fmt.Sprintf("%s completed", action.Title))
            }
        })
    }()
}
```

**Important - loop variable capture:**
```go
for _, action := range actions {
    action := action // Capture in local variable
    clickedCb := func(btn gtk.Button) {
        p.onActionClicked(button, &action)
    }
}
```

**Port Homebrew/Flatpak cleanup handlers:** Same pattern as custom actions, call pm.HomebrewCleanup() / pm.FlatpakUninstallUnused().
  </action>
  <verify>`go build ./internal/pages/maintenance/...` succeeds</verify>
  <done>page.go implements Page interface, renders all maintenance groups, action clicks tracked via operations with retry</done>
</task>

<task type="auto">
  <name>Task 3: Integrate maintenance page into userhome.go</name>
  <files>internal/views/userhome.go</files>
  <action>
Wire maintenance page package into userhome.go.

1. Add import: `"github.com/frostyard/chairlift/internal/pages/maintenance"`

2. Add field to UserHome struct:
   ```go
   maintenancePage *maintenance.Page
   ```

3. In buildPages() or wherever pages are created:
   ```go
   deps := pages.Deps{Config: uh.config, Toaster: uh.toastAdder}
   uh.maintenancePage = maintenance.New(deps)
   ```

4. Replace existing buildMaintenancePage() call with page widget integration:
   - Remove or comment out buildMaintenancePage()
   - Use uh.maintenancePage.Widget() where maintenancePrefsPage was used in viewStack

5. Add Destroy() call in cleanup (if exists) or add TODO comment for Phase 7

6. Remove dead code:
   - buildMaintenancePage() function
   - runMaintenanceAction() function
   - onBrewCleanupClicked() function
   - onFlatpakCleanupClicked() function
   - maintenancePrefsPage field

**Verify:** Existing functionality preserved - maintenance groups appear, buttons work.
  </action>
  <verify>`go build ./...` succeeds; run app, navigate to Maintenance page, verify groups and buttons display correctly</verify>
  <done>userhome.go uses maintenance.New(deps), old maintenance code removed</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles successfully
2. `go test ./internal/pages/maintenance/...` - all tests pass
3. Run application, navigate to Maintenance page:
   - System Cleanup group appears with configured actions
   - Homebrew Cleanup group appears (if Homebrew installed)
   - Flatpak Cleanup group appears (if Flatpak installed)
   - Click any action button - shows "Running...", completes with toast
   - Failed actions appear in operations popover with Retry button
</verification>

<success_criteria>
- Maintenance page package exists at internal/pages/maintenance/
- Logic layer has no GTK imports
- Tests pass without GTK runtime
- Page follows established pattern from Phase 4
- All original maintenance functionality works
- Operations tracking and retry work
</success_criteria>

<output>
After completion, create `.planning/phases/06-medium-pages/06-01-SUMMARY.md`
</output>
