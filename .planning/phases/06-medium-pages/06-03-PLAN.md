---
phase: 06-medium-pages
plan: 03
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - internal/pages/extensions/page.go
  - internal/views/userhome.go
  - internal/updex/updex.go
autonomous: true

must_haves:
  truths:
    - "Extensions page exists in its own package"
    - "Installed extensions display in expander rows"
    - "Discover button fetches available extensions"
    - "Install button installs extensions with progress"
    - "sysext operations have proper error handling"
  artifacts:
    - path: "internal/pages/extensions/page.go"
      provides: "GTK UI for extensions management"
      contains: "func New"
    - path: "internal/views/userhome.go"
      provides: "Integration with extensions package"
      contains: "extensions.New"
  key_links:
    - from: "internal/pages/extensions/page.go"
      to: "internal/pages/extensions/logic.go"
      via: "Client methods for data"
      pattern: "c\\.client\\."
    - from: "internal/pages/extensions/page.go"
      to: "internal/operations"
      via: "operations.Start for tracking"
      pattern: "operations\\.Start"
    - from: "internal/views/userhome.go"
      to: "internal/pages/extensions"
      via: "extensions.New import"
      pattern: 'extensions\\.New'
---

<objective>
Create Extensions UI layer and integrate both pages into userhome.go. Remove old CLI wrappers.

Purpose: Complete the Extensions page extraction with library-based operations and proper progress/error handling.
Output: extensions/page.go with full UI, userhome.go integration, CLI wrapper removed.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-medium-pages/06-CONTEXT.md
@.planning/phases/06-medium-pages/06-RESEARCH.md

# Prior plan output
@.planning/phases/06-medium-pages/06-02-SUMMARY.md

# Pattern to follow
@internal/pages/system/page.go
@internal/pages/maintenance/page.go

# Current implementation to extract
@internal/views/userhome.go (lines 746-1020)

# CLI wrapper to remove
@internal/updex/updex.go
@internal/instex/instex.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extensions UI layer</name>
  <files>internal/pages/extensions/page.go</files>
  <action>
Create GTK UI layer for extensions page following established pattern.

**Structure:**
```go
type Page struct {
    toolbarView *adw.ToolbarView
    prefsPage   *adw.PreferencesPage
    
    // UI state
    extensionsGroup     *adw.PreferencesGroup
    discoverEntry       *gtk.Entry
    discoverResultsGroup *adw.PreferencesGroup
    discoverResultRows   []*adw.ActionRow
    
    // Data
    installedComponentsMap map[string]bool
    
    // Dependencies
    config    *config.Config
    toaster   pages.Toaster
    client    *Client
    
    ctx    context.Context
    cancel context.CancelFunc
}

func New(deps pages.Deps) *Page
func (p *Page) Widget() *adw.ToolbarView
func (p *Page) Destroy()
```

**buildUI implementation:**
Port from userhome.go buildExtensionsPage:

1. **Installed Extensions Group:**
   - Check client.IsAvailable() instead of updex.IsInstalled()
   - Create PreferencesGroup with "Loading extensions..." description
   - Call loadExtensions() in goroutine

2. **loadExtensions() method:**
   - Call p.client.ListInstalled(ctx)
   - Group by component, create ExpanderRow for each
   - Add version rows with checkmark for current
   - Use async.RunOnMain for UI updates
   - Check p.ctx.Done() before UI updates

3. **Discover Group (if instex still used - see note):**
   - URL entry row with default URL
   - Discover button triggers onDiscoverClicked
   - Results group shows discovered extensions

4. **onDiscoverClicked:**
   - Disable button, show "Discovering..."
   - Call p.client.Discover(ctx, url)
   - Display results with install buttons

5. **onInstallExtensionClicked:**
   - Track via operations.Start()
   - Wire RetryFunc after Start()
   - Call p.client.Install(ctx, repoURL, component)
   - Update UI on completion
   - UserError on failure with "Couldn't install {component}"

**Important from CONTEXT.md:**
- Manual button click triggers discovery (not auto-discover on load)
- Errors appear in operations popover + toast notification
- Failed operations offer retry via operations popover

**Progress integration (from RESEARCH.md Pattern 4):**
For now, use simple client without progress since install operations are quick. Progress can be added later if needed.

**Note on instex:** Per RESEARCH.md open questions, instex may not have library equivalent yet. Keep instex CLI calls for discovery/install for now if updex library doesn't cover that functionality. Check updex library API - if it has Discover/Install, use library. If not, keep instex wrapper.
  </action>
  <verify>`go build ./internal/pages/extensions/...` succeeds</verify>
  <done>page.go implements full extensions UI with library-based operations</done>
</task>

<task type="auto">
  <name>Task 2: Integrate extensions page and remove old code</name>
  <files>internal/views/userhome.go, internal/updex/updex.go</files>
  <action>
Wire extensions page package into userhome.go and clean up old code.

**userhome.go changes:**

1. Add import: `"github.com/frostyard/chairlift/internal/pages/extensions"`

2. Add field to UserHome struct:
   ```go
   extensionsPage *extensions.Page
   ```

3. Create page with deps:
   ```go
   uh.extensionsPage = extensions.New(deps)
   ```

4. Replace buildExtensionsPage() usage with extensions page widget in viewStack

5. Remove dead code from userhome.go:
   - buildExtensionsPage() function
   - loadExtensions() function
   - onDiscoverClicked() function
   - displayDiscoveryResults() function
   - onInstallExtensionClicked() function
   - extensionsGroup, discoverEntry, discoverResultsGroup, discoverResultRows fields
   - installedComponentsMap field
   - extensionsPrefsPage field

6. Add Destroy() call if cleanup exists

**internal/updex/updex.go:**

Delete this file entirely. It's the CLI wrapper being replaced by the library.

If any other code imports internal/updex, update to use extensions.Client or direct updex library.

**Check for orphaned imports:**
Run `go build ./...` and fix any import errors from deleted updex package.
  </action>
  <verify>`go build ./...` succeeds; no imports of internal/updex remain</verify>
  <done>userhome.go uses extensions.New(deps), internal/updex deleted, old extensions code removed</done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration</name>
  <files>None (verification only)</files>
  <action>
Run comprehensive verification of both new pages.

1. Build entire project:
   ```bash
   go build ./...
   ```

2. Run all tests:
   ```bash
   go test ./internal/pages/...
   ```

3. Verify no CLI wrapper remnants:
   ```bash
   grep -r "exec.Command.*updex" internal/
   # Should return nothing
   ```

4. Run the application and test:
   - Navigate to Maintenance page
     - All groups display
     - Action buttons work
     - Operations tracked, retry works
   - Navigate to Extensions page
     - Installed extensions load
     - Discover works (if repository available)
     - Install works (if test extension available)

5. Verify error handling:
   - Disconnect network, try Discover - should show UserError
   - Failed operations appear in popover with Retry

If any issues found, fix in page.go or integration code.
  </action>
  <verify>All builds pass, all tests pass, manual testing confirms functionality</verify>
  <done>Both pages work identically to before extraction, with library-based updex operations</done>
</task>

</tasks>

<verification>
1. `go build ./...` - compiles successfully
2. `go test ./internal/pages/...` - all tests pass
3. `grep -r "internal/updex" internal/` - no references to old CLI wrapper
4. Run application:
   - Maintenance page: all groups, buttons, operations work
   - Extensions page: installed list, discover, install work
   - Errors show UserError format with retry in popover
</verification>

<success_criteria>
- Extensions page package exists at internal/pages/extensions/
- Page follows established pattern from Phase 4
- Uses updex library directly (no CLI subprocess)
- Operations tracked with retry support
- internal/updex/ CLI wrapper deleted
- All original functionality preserved
- userhome.go cleaner (extensions code extracted)
</success_criteria>

<output>
After completion, create `.planning/phases/06-medium-pages/06-03-SUMMARY.md`
</output>
