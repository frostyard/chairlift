---
phase: 07-complex-pages
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - internal/views/userhome.go
  - internal/views/shell.go
autonomous: true

must_haves:
  truths:
    - "userhome.go is renamed to shell.go reflecting its new role"
    - "Shell file is under 300 lines"
    - "Shell composes pages via page packages"
    - "Destroy() properly cleans up all page packages"
    - "All existing functionality preserved"
  artifacts:
    - path: "internal/views/shell.go"
      provides: "Thin shell composing page packages"
      min_lines: 100
      max_lines: 300
  key_links:
    - from: "internal/views/shell.go"
      to: "internal/pages/*"
      via: "page package constructors"
      pattern: "\\.(New|Widget|Destroy)\\("
---

<objective>
Reduce userhome.go to a thin shell and rename to shell.go to reflect its new composition role.

Purpose: After extracting Updates (Plan 01) and Applications (Plans 02-03) pages, userhome.go should be reduced to a thin shell that composes pages. Per CONTEXT.md, rename to shell.go to reflect this role.

Output: shell.go under 300 lines that creates and composes page packages with proper lifecycle management.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-complex-pages/07-CONTEXT.md
@.planning/phases/07-complex-pages/07-01-SUMMARY.md
@.planning/phases/07-complex-pages/07-02-SUMMARY.md

# Current shell code
@internal/views/userhome.go

# Page packages
@internal/pages/page.go
@internal/pages/system/page.go
@internal/pages/updates/page.go
@internal/pages/applications/page.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up remaining userhome.go code</name>
  <files>internal/views/userhome.go</files>
  <action>
Clean up userhome.go to remove remaining non-shell code:

1. Remove PM progress handling (onPMProgressUpdate, cleanupProgressUI):
   - This is ~170 lines of complex progress UI code
   - The operations popover already tracks operations
   - PM operations use operations.Start() which shows in the popover
   - DECISION: Remove this redundant progress UI - operations popover is the unified progress display

2. Remove progress UI tracking fields from UserHome struct:
   - progressBottomSheet, progressPage, progressScrolled
   - progressExpanders, progressGroups, progressRows, progressSpinners
   - progressActions, progressTasks
   - currentProgressMu

3. Remove BuildProgressBottomSheet() method (was for the now-unnecessary bottom sheet).

4. Remove PM re-initialization in New() goroutine:
   - The progress callback was for the bottom sheet which is being removed
   - PM managers are already initialized by app.go
   - DECISION: Remove re-initialization - simplify to just building pages

5. Clean up the goroutine in New() - it should only:
   - Wait briefly for PM availability checks if needed
   - That's it - page packages handle their own async loading

6. Keep in userhome.go (shell code):
   - ToastAdder interface
   - UserHome struct with page package fields
   - New() constructor creating page packages
   - GetPage() returning page widgets
   - createPage() helper (if still used) or remove if not
   - launchApp() and openURL() helpers

After cleanup, userhome.go should be ~200-250 lines of composition code.
  </action>
  <verify>
`go build ./...` succeeds.
`wc -l internal/views/userhome.go` is under 300 lines.
  </verify>
  <done>userhome.go cleaned of all non-shell code, under 300 lines.</done>
</task>

<task type="auto">
  <name>Task 2: Add proper Destroy() lifecycle management</name>
  <files>internal/views/userhome.go</files>
  <action>
Implement the Destroy() method that the TODO comment mentions:

1. Add Destroy() method to UserHome:
   ```go
   // Destroy cleans up all page packages, cancelling their goroutines.
   // Call this when the window is being destroyed.
   func (uh *UserHome) Destroy() {
       if uh.systemPagePkg != nil {
           uh.systemPagePkg.Destroy()
       }
       if uh.helpPagePkg != nil {
           uh.helpPagePkg.Destroy()
       }
       if uh.maintenancePagePkg != nil {
           uh.maintenancePagePkg.Destroy()
       }
       if uh.extensionsPagePkg != nil {
           uh.extensionsPagePkg.Destroy()
       }
       if uh.updatesPagePkg != nil {
           uh.updatesPagePkg.Destroy()
       }
       if uh.applicationsPagePkg != nil {
           uh.applicationsPagePkg.Destroy()
       }
   }
   ```

2. Remove the TODO comment since Destroy() is now implemented.

3. Update internal/window/window.go to call uh.Destroy() if there's a window close handler. Check if window.go has destruction handling - if not, note it as TODO for future.
  </action>
  <verify>
`go build ./...` succeeds.
`grep -c "func (uh \*UserHome) Destroy()" internal/views/userhome.go` returns 1.
  </verify>
  <done>Destroy() method implemented, calls Destroy() on all page packages.</done>
</task>

<task type="auto">
  <name>Task 3: Rename userhome.go to shell.go</name>
  <files>internal/views/userhome.go, internal/views/shell.go</files>
  <action>
Rename userhome.go to shell.go and update references:

1. Use git mv to preserve history:
   ```bash
   git mv internal/views/userhome.go internal/views/shell.go
   ```

2. Update the package comment in shell.go to reflect its role:
   ```go
   // Package views provides the shell that composes page packages.
   // This file creates and manages the lifecycle of all pages in the application.
   package views
   ```

3. Search for any imports or references to userhome.go in comments and update them.

4. Verify internal/window/window.go still works (it imports the package, not the file).

5. Final shell.go should contain:
   - ToastAdder interface
   - UserHome struct (consider renaming to Shell in a future cleanup, but keep for now to avoid breaking changes)
   - New() - creates all page packages
   - GetPage() - returns page widgets by name
   - Destroy() - cleans up page packages
   - launchApp() - launches apps via gtk-launch/flatpak
   - openURL() - opens URLs via xdg-open
   - Optionally createPage() if any pages still need it
  </action>
  <verify>
`go build ./...` succeeds.
`ls internal/views/shell.go` exists.
`ls internal/views/userhome.go` does not exist.
`wc -l internal/views/shell.go` is under 300 lines.
  </verify>
  <done>File renamed to shell.go, under 300 lines, reflects composition role.</done>
</task>

</tasks>

<verification>
1. `go build ./...` - Application compiles
2. `wc -l internal/views/shell.go` - Under 300 lines
3. Run application: All pages work correctly
4. Test: Navigate to each page (System, Updates, Applications, Maintenance, Extensions, Help)
5. Test: All functionality preserved (updates, app management, etc.)
6. Test: Operations show in operations popover (not redundant bottom sheet)
7. `git log --oneline internal/views/shell.go` shows history from userhome.go
</verification>

<success_criteria>
- shell.go exists and is under 300 lines
- userhome.go no longer exists
- Destroy() method implemented calling all page package Destroy()
- PM progress bottom sheet code removed (operations popover is sufficient)
- All pages compose via page packages
- Application functionality identical to before
- Git history preserved via git mv
</success_criteria>

<output>
After completion, create `.planning/phases/07-complex-pages/07-04-SUMMARY.md`
</output>
