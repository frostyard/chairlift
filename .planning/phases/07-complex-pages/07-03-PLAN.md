---
phase: 07-complex-pages
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - internal/pages/applications/logic.go
  - internal/pages/applications/page.go
  - internal/views/userhome.go
autonomous: true

must_haves:
  truths:
    - "User can see installed Flatpak apps (user and system)"
    - "User can uninstall Flatpak apps"
    - "User can see installed Snap packages"
    - "User can see Homebrew formulae and casks"
    - "User can search Homebrew and install packages"
    - "Search results display under search entry"
  artifacts:
    - path: "internal/pages/applications/logic.go"
      provides: "Search and package listing functions"
      contains: "func Search|func List"
    - path: "internal/pages/applications/page.go"
      provides: "Complete Applications page with all PM sections"
      contains: "buildFlatpak|buildHomebrew|buildSnap"
  key_links:
    - from: "internal/pages/applications/page.go"
      to: "internal/pm"
      via: "pm.ListFlatpakApplications, pm.HomebrewSearch"
      pattern: "pm\\.(List|Search)"
---

<objective>
Complete the Applications page by adding content sections for Flatpak, Homebrew, Snap, and unified search.

Purpose: This completes the Applications page extraction started in Plan 02. All PM sections with their list/install/uninstall functionality move from userhome.go to the applications package.

Output: Fully functional Applications page with all PM sections, search capability, and proper lifecycle management.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-complex-pages/07-CONTEXT.md
@.planning/phases/07-complex-pages/07-RESEARCH.md
@.planning/phases/07-complex-pages/07-02-SUMMARY.md

# Package being extended
@internal/pages/applications/logic.go
@internal/pages/applications/page.go

# Source code to migrate
@internal/views/userhome.go

# Dependencies
@internal/pm/wrapper.go
@internal/widgets/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend logic layer with search and list functions</name>
  <files>internal/pages/applications/logic.go</files>
  <action>
Extend the applications logic layer with search and data retrieval functions:

1. Add search result type:
   ```go
   type SearchResult struct {
       Name        string
       Description string
       PM          PMCategory
       IsInstalled bool
   }
   ```

2. Add search function for Homebrew (per CONTEXT.md - unified search with PM grouping):
   ```go
   func SearchHomebrew(query string) ([]SearchResult, error) {
       results, err := pm.HomebrewSearch(query)
       if err != nil {
           return nil, err
       }
       var searchResults []SearchResult
       for _, r := range results {
           searchResults = append(searchResults, SearchResult{
               Name: r.Name,
               PM:   CategoryHomebrew,
           })
       }
       return searchResults, nil
   }
   ```

Note: Per RESEARCH.md open question, Snap search may not be available in pm library. Check pm.SnapSearch - if not available, search will be Homebrew-only for now. Flatpak search via flathub could be added as enhancement.

3. Add helper to check if any PM with search capability is installed:
   ```go
   func HasSearchCapability() bool {
       return pm.HomebrewIsInstalled()
   }
   ```
  </action>
  <verify>
`go build ./internal/pages/applications/...` succeeds.
`grep -c "SearchResult" internal/pages/applications/logic.go` returns 1 or more.
  </verify>
  <done>logic.go extended with search types and functions.</done>
</task>

<task type="auto">
  <name>Task 2: Add PM content sections to page</name>
  <files>internal/pages/applications/page.go</files>
  <action>
Add all PM content sections to the Applications page:

1. Add new fields to Page struct:
   - flatpakUserExpander, flatpakSystemExpander *adw.ExpanderRow
   - snapExpander *adw.ExpanderRow
   - snapStoreLinkRow, snapStoreInstallRow *adw.ActionRow
   - snapRows []*adw.ActionRow
   - formulaeExpander, casksExpander *adw.ExpanderRow
   - searchEntry *gtk.SearchEntry
   - searchResultsExpander *adw.ExpanderRow

2. Replace buildContent() to build real content pages:
   - Build "all" page showing all installed apps from all PMs
   - Build "flatpak" page with user/system expanders
   - Build "homebrew" page with formulae/casks/search
   - Build "snap" page with installed snaps

3. Migrate and adapt buildApplicationsPage logic from userhome.go (lines 430-624):
   - buildFlatpakContent() - user and system app expanders
   - buildSnapContent() - snap store link/install, installed snaps
   - buildHomebrewContent() - bundle dump, formulae, casks
   - buildSearchGroup() - search entry and results expander

4. Migrate async loading functions from userhome.go:
   - loadFlatpakApplications() (lines 1200-1327)
   - loadSnapApplications() (lines 1329-1398)
   - onInstallSnapStoreClicked() (lines 1400-1438)
   - loadHomebrewPackages() (lines 1154-1198)
   - onHomebrewSearch() (lines 1546-1611)
   - onBrewBundleDumpClicked() (lines 1075-1089)

5. Build "all" content - show PreferencesPage with groups from all available PMs:
   ```go
   func (p *Page) buildAllContent() *adw.PreferencesPage {
       page := adw.NewPreferencesPage()

       // Add flatpak group if available
       if pm.FlatpakIsInstalled() && p.config.IsGroupEnabled("applications_page", "flatpak_user_group") {
           p.addFlatpakGroupsToPage(page)
       }

       // Add snap group if available
       if pm.SnapIsInstalled() && p.config.IsGroupEnabled("applications_page", "snap_group") {
           p.addSnapGroupToPage(page)
       }

       // Add homebrew group if available
       if pm.HomebrewIsInstalled() && p.config.IsGroupEnabled("applications_page", "brew_group") {
           p.addHomebrewGroupToPage(page)
       }

       // Add search at the bottom
       if HasSearchCapability() && p.config.IsGroupEnabled("applications_page", "brew_search_group") {
           p.addSearchGroupToPage(page)
       }

       return page
   }
   ```

6. Category-specific content pages show only that PM's sections.

7. CRITICAL patterns:
   - Always check p.ctx.Done() before async.RunOnMain
   - Capture loop variables: `app := app` before closures
   - Use async.NewUserError for user-friendly errors
   - Config-check before building groups: `p.config.IsGroupEnabled()`

8. Trigger async loads in buildUI() after constructing content:
   ```go
   // Start async loads
   if pm.FlatpakIsInstalled() {
       go p.loadFlatpakApplications()
   }
   if pm.SnapIsInstalled() {
       go p.loadSnapApplications()
   }
   if pm.HomebrewIsInstalled() {
       go p.loadHomebrewPackages()
   }
   ```
  </action>
  <verify>
`go build ./internal/pages/applications/...` succeeds.
`grep -c "loadFlatpakApplications\|loadSnapApplications\|loadHomebrewPackages" internal/pages/applications/page.go` returns 3.
  </verify>
  <done>Applications page has all PM content sections with list/uninstall/search functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Remove migrated code from userhome.go</name>
  <files>internal/views/userhome.go</files>
  <action>
Remove all Applications page code that was migrated to the applications package:

1. Remove from UserHome struct:
   - formulaeExpander, casksExpander, outdatedExpander, searchResultsExpander
   - searchEntry
   - flatpakUserExpander, flatpakSystemExpander
   - snapExpander, snapStoreLinkRow, snapStoreInstallRow, snapRows

2. Delete these methods from userhome.go:
   - buildApplicationsPage()
   - loadFlatpakApplications()
   - loadSnapApplications()
   - onInstallSnapStoreClicked()
   - loadHomebrewPackages()
   - onHomebrewSearch()
   - onBrewBundleDumpClicked()

3. Remove the buildApplicationsPage() call from the New() goroutine.

4. Verify the page is now fully provided by applicationsPagePkg.

5. Note: launchApp() and openURL() remain in userhome.go for now (used by other pages too). Plan 04 will determine if they should move.
  </action>
  <verify>
`go build ./...` succeeds.
`wc -l internal/views/userhome.go` shows significant reduction (expect ~500-600 lines, down from ~1100).
`grep -c "buildApplicationsPage\|loadFlatpakApplications" internal/views/userhome.go` returns 0.
  </verify>
  <done>userhome.go cleaned of all Applications page code, reduced by another ~500 lines.</done>
</task>

</tasks>

<verification>
1. `go build ./...` - Application compiles
2. Run application: Navigate to Applications page
3. Test: Sidebar "All Applications" shows content from all PMs
4. Test: Sidebar "Flatpak" shows user and system app expanders
5. Test: Flatpak uninstall buttons work
6. Test: Sidebar "Snap" shows installed snaps
7. Test: Sidebar "Homebrew" shows formulae, casks, and search
8. Test: Homebrew search returns results and install works
9. Verify: All async operations use context-based cancellation
</verification>

<success_criteria>
- Applications page shows all PM content sections
- Flatpak user/system apps display with uninstall capability
- Snap packages display with snap-store handling
- Homebrew formulae/casks display
- Homebrew search works with install buttons
- userhome.go reduced to ~500-600 lines
- No Applications-related methods remain in userhome.go
</success_criteria>

<output>
After completion, create `.planning/phases/07-complex-pages/07-03-SUMMARY.md`
</output>
