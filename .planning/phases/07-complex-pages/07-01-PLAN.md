---
phase: 07-complex-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pages/updates/logic.go
  - internal/pages/updates/page.go
autonomous: true

must_haves:
  truths:
    - "User can see NBC system update availability"
    - "User can check for and install NBC updates with progress"
    - "User can see Flatpak updates and update individual apps"
    - "User can update Homebrew and upgrade outdated packages"
    - "Update badge counts correctly reflect available updates"
  artifacts:
    - path: "internal/pages/updates/logic.go"
      provides: "Update checking functions without GTK dependencies"
      contains: "func Check"
    - path: "internal/pages/updates/page.go"
      provides: "Updates page UI"
      exports: ["New", "Page"]
  key_links:
    - from: "internal/pages/updates/page.go"
      to: "internal/nbc"
      via: "nbc.CheckUpdate, nbc.Update, nbc.Download"
      pattern: "nbc\\.(CheckUpdate|Update|Download)"
    - from: "internal/pages/updates/page.go"
      to: "internal/pm"
      via: "pm.ListFlatpakUpdates, pm.HomebrewUpdate"
      pattern: "pm\\.(ListFlatpakUpdates|HomebrewUpdate)"
---

<objective>
Extract the Updates page from userhome.go into its own package following the established page pattern.

Purpose: The Updates page handles NBC system updates and package manager updates (Flatpak, Homebrew). This extraction completes a major portion of the monolith split and maintains the established page architecture.

Output: A self-contained updates package with logic/UI separation, context-based lifecycle, and operations integration.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-complex-pages/07-CONTEXT.md
@.planning/phases/07-complex-pages/07-RESEARCH.md

# Existing page patterns to follow
@internal/pages/page.go
@internal/pages/system/page.go
@internal/pages/system/logic.go
@internal/pages/maintenance/page.go

# Source code to extract from
@internal/views/userhome.go

# Dependencies
@internal/nbc/nbc.go
@internal/pm/wrapper.go
@internal/operations/operations.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create updates logic layer</name>
  <files>internal/pages/updates/logic.go</files>
  <action>
Create the logic layer for the updates page with no GTK dependencies:

1. Define data types:
   - `NBCUpdateStatus` struct with UpdateNeeded, NewDigest, CurrentDigest fields
   - `UpdateCounts` struct to track NBC, Flatpak, Homebrew update counts

2. Create pure functions:
   - `IsNBCAvailable() bool` - checks if /run/nbc-booted exists
   - `CheckNBCUpdate(ctx context.Context) (*NBCUpdateStatus, error)` - wraps nbc.CheckUpdate
   - `CountFlatpakUpdates() int` - returns count via pm.ListFlatpakUpdates
   - `CountHomebrewOutdated() int` - returns count via pm.ListHomebrewOutdated

3. Follow the pattern from system/logic.go:
   - No imports of GTK/Adwaita packages
   - Use context.Context for cancellation
   - Return errors for caller to handle

4. Add package documentation comment.
  </action>
  <verify>
`go build ./internal/pages/updates/...` succeeds.
`grep -c "github.com/jwijenbergh/puregotk" internal/pages/updates/logic.go` returns 0.
  </verify>
  <done>logic.go exists with pure Go functions for update checking, no GTK imports.</done>
</task>

<task type="auto">
  <name>Task 2: Create updates page UI</name>
  <files>internal/pages/updates/page.go</files>
  <action>
Create the Updates page UI following the established page pattern:

1. Define Page struct with:
   - toolbarView, prefsPage (like system/page.go)
   - config, toaster from pages.Deps
   - ctx, cancel for goroutine lifecycle
   - Widget references: nbcCheckRow, nbcUpdateExpander, nbcUpdateBtn, nbcDownloadBtn
   - Widget references: flatpakUpdatesExpander, flatpakUpdateRows slice
   - Widget references: outdatedExpander (Homebrew)
   - Update count tracking: nbcUpdateCount, flatpakUpdateCount, brewUpdateCount, updateCountMu
   - Callback: onBadgeUpdate func(total int) for notifying parent of badge changes

2. Constructor New(deps pages.Deps, onBadgeUpdate func(int)) *Page:
   - Create context with cancel
   - Store dependencies
   - Call buildUI()
   - Return page

3. Implement Page interface:
   - Widget() *adw.ToolbarView
   - Destroy() - cancel context

4. Build UI method buildUI():
   - Create ToolbarView with HeaderBar
   - Create scrolled PreferencesPage
   - Call buildNBCUpdatesGroup() if NBC available and config enabled
   - Call buildFlatpakUpdatesGroup() if config enabled
   - Call buildHomebrewUpdatesGroup() if config enabled

5. NBC Updates group (migrate from userhome.go lines 325-376):
   - Check row with "Check" button
   - Update expander with Download and Update buttons
   - Progress display inside expander
   - Auto-check on page load via goroutine

6. Flatpak Updates group (migrate from userhome.go lines 378-393):
   - Updates expander showing available updates
   - Per-app Update buttons
   - loadFlatpakUpdates() async function

7. Homebrew Updates group (migrate from userhome.go lines 395-427):
   - Update Homebrew button (with operations.Start tracking)
   - Outdated packages expander with per-package Upgrade buttons
   - loadOutdatedPackages() async function

8. Badge count management:
   - updateBadgeCount() method that sums counts and calls onBadgeUpdate callback
   - Each load function updates its count and calls updateBadgeCount()

9. Migrate these handlers from userhome.go:
   - onNBCCheckUpdateClicked, checkNBCUpdateAvailability (lines 689-778)
   - onNBCUpdateClicked, onNBCDownloadClicked (lines 780-1036)
   - onUpdateHomebrewClicked (lines 1038-1073)
   - loadOutdatedPackages (lines 1091-1152)
   - loadFlatpakUpdates (lines 1441-1544)

CRITICAL patterns to follow:
- Always check p.ctx.Done() before async.RunOnMain UI updates
- Capture loop variables before closures (e.g., `pkg := pkg`)
- Use operations.Start for Homebrew update with RetryFunc wiring
- Use async.NewUserError for user-friendly error messages
  </action>
  <verify>
`go build ./internal/pages/updates/...` succeeds.
`grep -c "pages.Page" internal/pages/updates/page.go` returns 1 or more (implements interface).
  </verify>
  <done>Updates page package exists with NBC, Flatpak, and Homebrew update sections, implementing pages.Page interface.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate updates page into userhome.go</name>
  <files>internal/views/userhome.go</files>
  <action>
Integrate the new updates page package into userhome.go:

1. Add import: `"github.com/frostyard/chairlift/internal/pages/updates"`

2. Add field to UserHome struct:
   - `updatesPagePkg *updates.Page`

3. Modify New() constructor:
   - Create updates page: `uh.updatesPagePkg = updates.New(deps, uh.toastAdder.SetUpdateBadge)`
   - Get widget: `uh.updatesPage = uh.updatesPagePkg.Widget()`
   - Remove the line `uh.updatesPage, uh.updatesPrefsPage = uh.createPage()`
   - Remove `uh.buildUpdatesPage()` from the goroutine

4. Remove from UserHome struct:
   - `updatesPrefsPage *adw.PreferencesPage`
   - `nbcUpdateBtn`, `nbcDownloadBtn`, `nbcUpdateExpander`, `nbcCheckRow`
   - `flatpakUpdatesExpander`, `flatpakUpdateRows`
   - `outdatedExpander`
   - `nbcUpdateCount`, `flatpakUpdateCount`, `brewUpdateCount`, `updateCountMu`

5. Delete these methods from userhome.go:
   - buildUpdatesPage()
   - onNBCCheckUpdateClicked()
   - checkNBCUpdateAvailability()
   - onNBCUpdateClicked()
   - onNBCDownloadClicked()
   - onUpdateHomebrewClicked()
   - loadOutdatedPackages()
   - loadFlatpakUpdates()
   - updateBadgeCount()

6. Update TODO comment to include updates page in Destroy() example.

7. Verify GetPage("updates") still works (returns uh.updatesPage).
  </action>
  <verify>
`go build ./...` succeeds.
`wc -l internal/views/userhome.go` shows significant reduction (expect ~1100-1200 lines, down from 1811).
  </verify>
  <done>Updates page extracted, userhome.go reduced by ~600 lines, application compiles and runs.</done>
</task>

</tasks>

<verification>
1. `go build ./...` - Application compiles
2. `go test ./internal/pages/updates/...` - Any tests pass (if created)
3. Run application: Updates page displays all three sections (NBC if available, Flatpak, Homebrew)
4. Test: Check for NBC updates button works
5. Test: Flatpak updates load and display
6. Test: Homebrew Update button triggers operation (visible in operations popover)
7. Test: Update badge in sidebar reflects available updates
</verification>

<success_criteria>
- Updates page exists in internal/pages/updates/ with logic.go and page.go
- Page implements pages.Page interface (Widget, Destroy)
- NBC, Flatpak, and Homebrew update sections work identically to before
- Badge count updates correctly
- userhome.go is reduced by ~600 lines
- No GTK imports in logic.go
</success_criteria>

<output>
After completion, create `.planning/phases/07-complex-pages/07-01-SUMMARY.md`
</output>
