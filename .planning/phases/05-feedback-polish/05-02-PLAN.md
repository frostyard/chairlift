---
phase: 05-feedback-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/window/window.go
  - internal/views/userhome.go
autonomous: true

must_haves:
  truths:
    - "Dry-run mode shows banner with 'Understood' button at top of window"
    - "Banner can be dismissed via 'Understood' button (acknowledgment action)"
    - "Failed operations can be retried via retry button"
  artifacts:
    - path: "internal/window/window.go"
      provides: "Dry-run mode banner"
      contains: "adw.NewBanner"
    - path: "internal/views/userhome.go"
      provides: "RetryFunc wiring for operations"
      contains: "RetryFunc"
  key_links:
    - from: "internal/window/window.go"
      to: "internal/pm/wrapper.go"
      via: "pm.IsDryRun() call in buildUI() to set dryRunBanner.SetRevealed()"
      pattern: "pm\\.IsDryRun\\(\\)"
    - from: "internal/views/userhome.go"
      to: "internal/operations/popover.go"
      via: "op.RetryFunc assignment enables Retry button"
      pattern: "op\\.RetryFunc\\s*="
---

<objective>
Add dry-run mode banner to window and ensure operations have RetryFunc wired for retry capability.

Purpose: Users need clear visual indication when in dry-run mode, and failed operations should be retryable without restarting the app.
Output: Persistent banner for dry-run mode, validated retry functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-feedback-polish/05-RESEARCH.md

@internal/window/window.go
@internal/views/userhome.go
@internal/operations/popover.go
@internal/pm/wrapper.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dry-run banner to window</name>
  <files>internal/window/window.go</files>
  <action>
Modify internal/window/window.go to add a dismissible banner for dry-run mode:

1. Add import for "github.com/frostyard/chairlift/internal/pm"

2. Add field to Window struct:
   ```go
   dryRunBanner *adw.Banner
   ```

3. In buildUI(), after creating progressSheet and before toasts:
   - Create the banner with dismissibility via action button:
   ```go
   w.dryRunBanner = adw.NewBanner("Dry-Run Mode: Changes will be simulated only")
   w.dryRunBanner.SetButtonLabel("Understood")  // Adds dismissible action button
   w.dryRunBanner.SetRevealed(pm.IsDryRun())    // Call pm.IsDryRun() to set revealed state
   w.dryRunBanner.ConnectButtonClicked(func() {
       w.dryRunBanner.SetRevealed(false)        // Dismiss on click
   })
   ```

4. Modify the widget hierarchy in buildUI():
   - Current: toasts.SetChild(&progressSheet.Widget)
   - New: Create a vertical box that contains banner + progressSheet:
   ```go
   // Create content box for banner + main content
   contentBox := gtk.NewBox(gtk.OrientationVerticalValue, 0)
   contentBox.Append(&w.dryRunBanner.Widget)
   contentBox.Append(&progressSheet.Widget)
   
   // Set as toast overlay child
   w.toasts.SetChild(&contentBox.Widget)
   ```

Note: pm.IsDryRun() is checked once at window creation. User can dismiss with "Understood" button after acknowledging dry-run mode.
  </action>
  <verify>Run app with `--dry-run` flag, verify banner appears with "Understood" button, click it to dismiss: `go run . --dry-run`</verify>
  <done>Dry-run mode shows banner with "Understood" button at window top, clicking dismisses it, banner not shown in normal mode</done>
</task>

<task type="auto">
  <name>Task 2: Wire RetryFunc for Update Homebrew operation</name>
  <files>internal/views/userhome.go</files>
  <action>
Modify the onUpdateHomebrewClicked function (around line 1499) to set RetryFunc on the operation.

Current code at line 1505:
```go
op := operations.Start("Update Homebrew", operations.CategoryUpdate, false)
```

Add RetryFunc immediately after operations.Start():
```go
func (uh *UserHome) onUpdateHomebrewClicked(button *gtk.Button) {
    // Disable button and show working state
    button.SetSensitive(false)
    button.SetLabel("Updating...")

    // Start tracked operation (visible in operations popover)
    op := operations.Start("Update Homebrew", operations.CategoryUpdate, false)
    
    // Wire retry capability - self-referential function for retry button
    op.RetryFunc = func() {
        uh.onUpdateHomebrewClicked(button)
    }

    go func() {
        err := pm.HomebrewUpdate()
        // ... rest unchanged
    }()
}
```

The key addition is the two lines after operations.Start():
```go
op.RetryFunc = func() {
    uh.onUpdateHomebrewClicked(button)
}
```

This enables the Retry button in the operations popover (already implemented in popover.go lines 264-280) to restart the update operation when clicked.
  </action>
  <verify>
1. `go build ./...` succeeds
2. Run app, trigger Update Homebrew, simulate failure (disconnect network or use --dry-run)
3. Open operations popover, verify "Retry" button appears for failed operation
4. Click Retry, verify new operation starts
  </verify>
  <done>onUpdateHomebrewClicked sets op.RetryFunc enabling retry via operations popover</done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go vet ./...` passes
3. App runs with `--dry-run` shows banner
4. App runs without `--dry-run` shows no banner
5. Failed operations show Retry button in popover
</verification>

<success_criteria>
- Dry-run banner visible when running with --dry-run flag
- Banner not visible in normal mode
- Failed operations show Retry button
- Clicking Retry dismisses failed operation and starts new attempt
</success_criteria>

<output>
After completion, create `.planning/phases/05-feedback-polish/05-02-SUMMARY.md`
</output>
