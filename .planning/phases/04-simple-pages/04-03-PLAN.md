---
phase: 04-simple-pages
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - internal/views/userhome.go
  - internal/pages/help/logic_test.go
  - internal/pages/system/logic_test.go
autonomous: true

must_haves:
  truths:
    - "userhome.go uses page packages instead of inline buildSystemPage/buildHelpPage"
    - "System and Help pages work identically to before extraction"
    - "Page Destroy() is called when appropriate"
    - "Business logic has unit tests"
  artifacts:
    - path: "internal/views/userhome.go"
      provides: "Integration with page packages"
      contains: "pages/system"
    - path: "internal/pages/help/logic_test.go"
      provides: "Tests for help logic"
      contains: "func TestBuildResourceLinks"
    - path: "internal/pages/system/logic_test.go"
      provides: "Tests for system logic"
      contains: "func TestParseOSRelease"
  key_links:
    - from: "internal/views/userhome.go"
      to: "internal/pages/system"
      via: "creates system page"
      pattern: "system\\.New"
    - from: "internal/views/userhome.go"
      to: "internal/pages/help"
      via: "creates help page"
      pattern: "help\\.New"
---

<objective>
Integrate extracted pages into userhome.go and add unit tests for business logic.

Purpose: Complete the page extraction by wiring the new packages into the existing application, removing the old inline code, and validating that business logic is testable.

Output: Modified userhome.go using page packages, unit tests for logic layers.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-simple-pages/04-RESEARCH.md
@.planning/phases/04-simple-pages/04-01-SUMMARY.md
@.planning/phases/04-simple-pages/04-02-SUMMARY.md

@internal/views/userhome.go
@internal/pages/page.go
@internal/pages/help/page.go
@internal/pages/help/logic.go
@internal/pages/system/page.go
@internal/pages/system/logic.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate page packages into userhome.go</name>
  <files>internal/views/userhome.go</files>
  <action>
Modify `internal/views/userhome.go` to use the extracted page packages:

1. Add imports:
   - `"github.com/frostyard/chairlift/internal/pages"`
   - `"github.com/frostyard/chairlift/internal/pages/help"`
   - `"github.com/frostyard/chairlift/internal/pages/system"`

2. Add fields to UserHome struct:
   - `systemPagePkg *system.Page` - the extracted system page
   - `helpPagePkg *help.Page` - the extracted help page
   - Keep existing `systemPage *adw.ToolbarView` and `helpPage *adw.ToolbarView` for now (they store the Widget())

3. In `New()` function, after pages are created via createPage():
   - Create deps: `deps := pages.Deps{Config: cfg, Toaster: toastAdder}`
   - Create system page: `uh.systemPagePkg = system.New(deps, uh.launchApp, uh.openURL)`
   - Create help page: `uh.helpPagePkg = help.New(deps, uh.openURL)`
   - Store widgets: `uh.systemPage = uh.systemPagePkg.Widget()` (replaces createPage call for system)
   - Store widgets: `uh.helpPage = uh.helpPagePkg.Widget()` (replaces createPage call for help)

4. In the goroutine in New() where buildSystemPage and buildHelpPage are called:
   - Remove calls to `uh.buildSystemPage()` and `uh.buildHelpPage()`
   - Keep calls to buildUpdatesPage, buildApplicationsPage, etc.
   - The page packages build their UI in their constructors

5. Delete the following methods (now in page packages):
   - `buildSystemPage()` (lines ~236-295)
   - `loadOSRelease()` (lines ~298-343)
   - `loadNBCStatus()` (lines ~346-423)
   - `buildHelpPage()` (lines ~1192-1265)
   - Keep `onSystemUpdateClicked` - that's in the Updates page, not System page
    
6. Lifecycle for Destroy() - choose ONE approach based on codebase pattern:
   
   **Option A (Preferred if UserHome has cleanup):** Add a `Destroy()` method to UserHome:
   ```go
   func (uh *UserHome) Destroy() {
       if uh.systemPagePkg != nil {
           uh.systemPagePkg.Destroy()
       }
       if uh.helpPagePkg != nil {
           uh.helpPagePkg.Destroy()
       }
   }
   ```
   Document: This should be called when the window closes or view is removed.
   
   **Option B (If no cleanup pattern exists yet):** Acknowledge Destroy() is future-proofing:
   - The pages have Destroy() methods ready for when app lifecycle management is added
   - Help page's Destroy() is a no-op (no goroutines)
   - System page's Destroy() cancels the NBC status fetch goroutine
   - Add TODO comment in userhome.go: `// TODO: Call page Destroy() methods when view lifecycle is added`
   
   Check existing codebase: Does window.go or any parent call a cleanup method? If yes, use Option A. If no cleanup pattern exists, use Option B.

7. The GetPage() method should continue to work unchanged since it returns uh.systemPage/uh.helpPage which are still ToolbarViews.

IMPORTANT: Keep systemPrefsPage and helpPrefsPage references - they're used elsewhere. Actually, check if they're used. If buildSystemPage/buildHelpPage are the only users, remove those fields too.

Actually, look at the struct - systemPrefsPage is stored to prevent GC. The page packages handle their own GC prevention by storing references in the Page struct. So we can remove systemPrefsPage and helpPrefsPage fields since the page packages manage those.
  </action>
  <verify>
`go build ./internal/views/...` succeeds
  </verify>
  <done>
userhome.go uses page packages for System and Help pages, old methods removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for business logic</name>
  <files>
internal/pages/help/logic_test.go
internal/pages/system/logic_test.go
  </files>
  <action>
Create unit tests for the logic layers:

**internal/pages/help/logic_test.go:**

1. Package: `package help`

2. Import: testing, internal/config

3. `TestBuildResourceLinks(t *testing.T)`:
   - Test with nil config returns nil
   - Test with empty config returns empty slice
   - Test with Website only returns 1 link with correct fields
   - Test with all fields (Website, Issues, Chat) returns 3 links in order
   - Verify Title, Subtitle, URL are set correctly for each link type

4. `TestBuildResourceLinks_PartialConfig(t *testing.T)`:
   - Test with only Issues set returns 1 link
   - Test with Website and Chat (no Issues) returns 2 links

**internal/pages/system/logic_test.go:**

1. Package: `package system`

2. Import: testing, strings

3. `TestFormatKey(t *testing.T)`:
   - Test "PRETTY_NAME" -> "Pretty Name"
   - Test "VERSION_ID" -> "Version Id"
   - Test "HOME_URL" -> "Home Url"

4. `TestParseOSRelease(t *testing.T)`:
   - This reads /etc/os-release which exists on Linux
   - Verify it returns entries without error
   - Verify entries have non-empty Key, Value, DisplayKey
   - Verify entries ending in URL have IsURL=true

5. `TestIsNBCAvailable(t *testing.T)`:
   - Just call the function and verify it returns bool without panic
   - Don't assert true/false as it depends on the system

NOTE: formatKey is a private function. Either:
- Export it as FormatKey for testing, or
- Test it indirectly via ParseOSRelease output

Recommend: Keep it private, test indirectly by verifying DisplayKey format in ParseOSRelease test.

Tests should run without GTK: `go test ./internal/pages/... -v`
  </action>
  <verify>
`go test ./internal/pages/... -v` passes
  </verify>
  <done>
Unit tests exist for help/logic.go and system/logic.go, all tests pass
  </done>
</task>

</tasks>

<verification>
- [ ] `go build ./...` compiles successfully
- [ ] `go test ./internal/pages/... -v` passes
- [ ] `go test ./internal/views/... -v` passes (if any tests exist)
- [ ] Application runs and System/Help pages work correctly
- [ ] buildSystemPage and buildHelpPage methods removed from userhome.go
- [ ] Page packages are imported and used in userhome.go
</verification>

<success_criteria>
- userhome.go uses page packages instead of inline build methods
- Old buildSystemPage, loadOSRelease, loadNBCStatus, buildHelpPage methods removed
- Unit tests pass for logic layers
- Application compiles and pages work as before
- MANUAL TEST: Run the app and verify System and Help pages display correctly (visual parity with pre-extraction behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/04-simple-pages/04-03-SUMMARY.md`
</output>
