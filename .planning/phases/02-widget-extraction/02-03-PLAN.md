---
phase: 02-widget-extraction
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - internal/views/userhome.go
autonomous: true

must_haves:
  truths:
    - "At least one usage of AsyncExpanderRow in userhome.go"
    - "At least one usage of LoadingRow in userhome.go"
    - "At least one usage of row builder in userhome.go"
    - "Widgets are validated by actual use in existing code"
  artifacts:
    - path: "internal/views/userhome.go"
      provides: "Modified to use widgets package"
      contains: "widgets.NewAsyncExpanderRow"
  key_links:
    - from: "internal/views/userhome.go"
      to: "internal/widgets"
      via: "import statement"
      pattern: "github.com/frostyard/chairlift/internal/widgets"
---

<objective>
Validate extracted widgets by migrating one real usage in userhome.go.

Purpose: Ensure the widgets work correctly in practice by replacing inline patterns with widget calls. This validates Success Criteria #5: "Widgets are used in at least one place in existing code."

Output: Modified internal/views/userhome.go using at least one of each widget type
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-widget-extraction/02-RESEARCH.md

# Widgets package from prior plans
@internal/widgets/doc.go
@internal/widgets/async_expander.go
@internal/widgets/action_button.go
@internal/widgets/loading_row.go
@internal/widgets/rows.go

# File to modify
@internal/views/userhome.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate loadNBCStatus to use AsyncExpanderRow</name>
  <files>internal/views/userhome.go</files>
  <action>
Refactor the loadNBCStatus function (around lines 353-459) to use AsyncExpanderRow.

Changes needed:

1. Add import for widgets package:
   "github.com/frostyard/chairlift/internal/widgets"

2. In buildSystemPage where nbcExpander is created (around line 262-269):
   - Replace inline adw.NewExpanderRow() with widgets.NewAsyncExpanderRow()
   - Change the field type or use .Expander to access the underlying widget

3. Refactor loadNBCStatus function:
   - Accept *widgets.AsyncExpanderRow instead of *adw.ExpanderRow
   - Replace inline loading row creation with expander.StartLoading("Fetching system info")
   - Replace inline error row creation with expander.SetError(message)
   - Replace success setup with expander.SetContent(subtitle)
   - Add content rows to expander.Expander instead of directly

This is a focused migration of ONE pattern to validate the widget works. Do NOT migrate all 8+ ExpanderRow usages - just this one.

Preserve all existing functionality. The refactored code should behave identically to the original.
  </action>
  <verify>
`go build ./...` succeeds
`grep -l "widgets.NewAsyncExpanderRow" internal/views/userhome.go` finds the usage
  </verify>
  <done>
loadNBCStatus uses AsyncExpanderRow with StartLoading/SetError/SetContent
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate one row builder usage</name>
  <files>internal/views/userhome.go</files>
  <action>
Refactor ONE usage of a row builder pattern to use widgets.NewLinkRow or widgets.NewInfoRow.

Good candidate: perfRow in buildSystemPage (around lines 280-300)
- Currently creates ActionRow, sets title/subtitle, adds external link icon, connects activated signal
- Replace with widgets.NewLinkRow(title, subtitle, onClickFunc)

This validates the row builder factory functions work correctly.

Do NOT migrate all row patterns - just this one example to validate the widget.
  </action>
  <verify>
`go build ./...` succeeds
`grep -l "widgets.NewLinkRow\|widgets.NewInfoRow\|widgets.NewButtonRow" internal/views/userhome.go` finds usage
  </verify>
  <done>
At least one row builder function is used in userhome.go
  </done>
</task>

</tasks>

<verification>
```bash
# Full build passes (includes userhome.go)
go build ./...

# No vet issues
go vet ./...

# Verify widget usages exist
grep "widgets\\.NewAsyncExpanderRow\\|widgets\\.NewLoadingRow\\|widgets\\.NewLinkRow\\|widgets\\.NewInfoRow\\|widgets\\.NewButtonRow" internal/views/userhome.go

# Verify import exists
grep "github.com/frostyard/chairlift/internal/widgets" internal/views/userhome.go
```
</verification>

<success_criteria>
- userhome.go imports internal/widgets package
- loadNBCStatus uses AsyncExpanderRow instead of inline pattern
- At least one row uses a builder function (NewLinkRow, NewInfoRow, etc.)
- Full application builds successfully
- go vet passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-widget-extraction/02-03-SUMMARY.md`
</output>
