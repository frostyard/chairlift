---
phase: 02-widget-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/widgets/doc.go
  - internal/widgets/async_expander.go
autonomous: true

must_haves:
  truths:
    - "AsyncExpanderRow exists as a reusable widget"
    - "AsyncExpanderRow handles loading state with spinner"
    - "AsyncExpanderRow handles error display with icon"
    - "AsyncExpanderRow handles content population"
  artifacts:
    - path: "internal/widgets/doc.go"
      provides: "Package documentation and overview"
      min_lines: 20
    - path: "internal/widgets/async_expander.go"
      provides: "AsyncExpanderRow type with factory function and methods"
      exports: ["AsyncExpanderRow", "NewAsyncExpanderRow"]
      min_lines: 60
  key_links:
    - from: "internal/widgets/async_expander.go"
      to: "internal/async"
      via: "import for threading context"
      pattern: "github.com/frostyard/chairlift/internal/async"
---

<objective>
Create the widgets package and implement AsyncExpanderRow for async-aware expander rows.

Purpose: Establish the internal/widgets package and extract the first reusable pattern - the async expander row that handles loading state, error display, and content population. This addresses requirement ARCH-02.

Output: internal/widgets/doc.go and internal/widgets/async_expander.go
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-widget-extraction/02-RESEARCH.md

# Phase 1 established async patterns
@internal/async/scheduler.go
@internal/async/errors.go

# Reference for patterns being extracted
@internal/views/userhome.go (lines 247-269, 305-459 for ExpanderRow patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widgets package with doc.go</name>
  <files>internal/widgets/doc.go</files>
  <action>
Create internal/widgets/doc.go with package documentation explaining:
- Purpose: Reusable GTK4/Libadwaita widget patterns for Go/puregotk
- Design approach: Composition-based wrappers (factory functions returning configured widgets + helper methods)
- Why not inheritance: puregotk doesn't support Go-level GObject subclassing
- Thread safety: All methods that touch GTK must be called from main thread or via async.RunOnMain()
- Available widgets: AsyncExpanderRow, ActionButton, LoadingRow, row builders

Follow Go doc conventions. Include example usage in package doc. Reference internal/async for threading.
  </action>
  <verify>
`go build ./internal/widgets/...` succeeds
  </verify>
  <done>
internal/widgets/doc.go exists with package documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AsyncExpanderRow widget</name>
  <files>internal/widgets/async_expander.go</files>
  <action>
Create internal/widgets/async_expander.go implementing AsyncExpanderRow based on RESEARCH.md Pattern 1.

The AsyncExpanderRow struct should contain:
- Expander *adw.ExpanderRow - the underlying widget
- loadingRow *adw.ActionRow - current loading indicator (nil when not loading)
- spinner *gtk.Spinner - current spinner (nil when not loading)

Implement these factory functions and methods:

1. NewAsyncExpanderRow(title, subtitle string) *AsyncExpanderRow
   - Creates expander with title and subtitle
   - Returns wrapper struct

2. StartLoading(message string)
   - Creates ActionRow with spinner as prefix
   - Sets row title to message, subtitle to "Please wait..."
   - Starts spinner
   - Adds row to expander
   - Stores references to loadingRow and spinner

3. StopLoading()
   - If loadingRow is not nil, removes it from expander
   - Nils out loadingRow and spinner references
   - Safe to call multiple times (idempotent)

4. SetError(message string)
   - Calls StopLoading() first
   - Sets expander subtitle to "Failed to load"
   - Creates error ActionRow with dialog-error-symbolic icon prefix
   - Adds error row to expander

5. SetContent(subtitle string)
   - Calls StopLoading() first
   - Sets expander subtitle to the provided string
   - Caller adds content rows to Expander directly

Document that all methods must be called from main thread. Reference async.RunOnMain() for goroutine updates.
  </action>
  <verify>
`go build ./internal/widgets/...` succeeds
`go vet ./internal/widgets/...` has no errors
  </verify>
  <done>
AsyncExpanderRow type exists with NewAsyncExpanderRow, StartLoading, StopLoading, SetError, SetContent methods
  </done>
</task>

</tasks>

<verification>
```bash
# Package compiles
go build ./internal/widgets/...

# No vet issues
go vet ./internal/widgets/...

# Verify exports exist
grep -l "type AsyncExpanderRow struct" internal/widgets/async_expander.go
grep -l "func NewAsyncExpanderRow" internal/widgets/async_expander.go
```
</verification>

<success_criteria>
- internal/widgets package exists and compiles
- AsyncExpanderRow type is exported
- NewAsyncExpanderRow factory function is exported
- StartLoading, StopLoading, SetError, SetContent methods exist
- doc.go provides package documentation
</success_criteria>

<output>
After completion, create `.planning/phases/02-widget-extraction/02-01-SUMMARY.md`
</output>
