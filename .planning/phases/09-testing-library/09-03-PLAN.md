---
phase: 09-testing-library
plan: 03
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - pkg/adwutil/doc.go
  - pkg/adwutil/async.go
  - pkg/adwutil/errors.go
  - pkg/adwutil/errors_test.go
  - internal/async/scheduler.go
  - internal/async/errors.go
autonomous: true

must_haves:
  truths:
    - "Library exists at pkg/adwutil with no internal chairlift imports"
    - "RunOnMain function is exposed in adwutil package"
    - "UserError type is exposed in adwutil package"
    - "Internal async package re-exports from adwutil"
  artifacts:
    - path: "pkg/adwutil/doc.go"
      provides: "Package documentation with examples"
      min_lines: 30
    - path: "pkg/adwutil/async.go"
      provides: "RunOnMain and callback registry"
      min_lines: 50
    - path: "pkg/adwutil/errors.go"
      provides: "UserError type and constructors"
      min_lines: 60
    - path: "pkg/adwutil/errors_test.go"
      provides: "Tests copied from internal/async"
      min_lines: 60
  key_links:
    - from: "internal/async/scheduler.go"
      to: "pkg/adwutil/async.go"
      via: "re-export or thin wrapper"
      pattern: "adwutil\\."
---

<objective>
Extract async utilities to pkg/adwutil library package.

Purpose: Begin library extraction by moving core async infrastructure (RunOnMain, UserError) to pkg/adwutil, enabling reuse in other GTK4/Go projects.
Output: New pkg/adwutil package with async and error handling, internal packages updated to use it.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-testing-library/09-CONTEXT.md
@.planning/phases/09-testing-library/09-RESEARCH.md

Code to extract:
@internal/async/scheduler.go
@internal/async/errors.go

Tests to migrate:
@internal/async/errors_test.go (from 09-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pkg/adwutil with doc and async</name>
  <files>
pkg/adwutil/doc.go
pkg/adwutil/async.go
  </files>
  <action>
Create the pkg/adwutil library package with RunOnMain functionality.

1. Create pkg/adwutil/doc.go with comprehensive package documentation:

```go
/*
Package adwutil provides reusable GTK4/Libadwaita patterns for Go applications.

This package extracts common patterns from ChairLift into a reusable library,
including async utilities, error handling, and widget helpers.

# Thread Safety

GTK is not thread-safe. All widget operations must occur on the GTK main thread.
Use [RunOnMain] to schedule UI updates from goroutines:

    go func() {
        result := doWork()
        adwutil.RunOnMain(func() {
            label.SetText(result)
        })
    }()

# Error Handling

The [UserError] type provides user-friendly error messages while preserving
technical details for logging:

    err := adwutil.NewUserErrorWithHint(
        "Couldn't install Firefox",
        "Check your internet connection",
        technicalErr,
    )
    // err.FormatForUser() returns "Couldn't install Firefox: Check your internet connection"
    // err.FormatWithDetails() includes technical error for debugging

# Tone Guidelines

Error messages follow GNOME HIG tone guidelines:
  - Use "Couldn't" not "Failed to" or "Error:"
  - Keep summaries short and action-oriented
  - Include hints only when actionable

# Widgets (coming soon)

The package will provide helper functions for common widget patterns:
  - Empty state displays
  - Action rows with buttons
  - Loading indicators
  - Progress tracking
*/
package adwutil
```

2. Create pkg/adwutil/async.go:

Copy the content from internal/async/scheduler.go but change package to `adwutil`.
The code should be identical except for the package declaration:

```go
// Package adwutil provides reusable GTK4/Libadwaita patterns.
//
// This file provides thread-safe utilities for goroutine-to-UI communication.
package adwutil

import (
    "sync"

    "github.com/jwijenbergh/puregotk/v4/glib"
)

// callbackRegistry stores callbacks to prevent GC collection before GTK executes them.
var (
    callbackMu sync.Mutex
    callbacks  = make(map[uintptr]func())
    callbackID uintptr
)

// RunOnMain schedules a function to run on the GTK main thread.
//
// This is the ONLY safe way to update UI from goroutines. GTK is not thread-safe;
// calling widget methods from goroutines will cause segfaults or silent corruption.
//
// Example:
//
//    go func() {
//        data, err := fetchData()
//        adwutil.RunOnMain(func() {
//            if err != nil {
//                showError(err)
//                return
//            }
//            updateUI(data)
//        })
//    }()
func RunOnMain(fn func()) {
    callbackMu.Lock()
    callbackID++
    id := callbackID
    callbacks[id] = fn
    callbackMu.Unlock()

    cb := glib.SourceFunc(func(data uintptr) bool {
        callbackMu.Lock()
        callback, ok := callbacks[data]
        delete(callbacks, data)
        callbackMu.Unlock()

        if ok {
            callback()
        }
        return false
    })

    glib.IdleAdd(&cb, id)
}
```

IMPORTANT: Verify no internal chairlift imports in pkg/adwutil:
- Only imports: sync, github.com/jwijenbergh/puregotk/v4/glib
  </action>
  <verify>go build ./pkg/adwutil/...</verify>
  <done>pkg/adwutil/doc.go and async.go created, package compiles with no internal imports</done>
</task>

<task type="auto">
  <name>Task 2: Extract UserError to adwutil</name>
  <files>
pkg/adwutil/errors.go
pkg/adwutil/errors_test.go
  </files>
  <action>
Move UserError type and tests to pkg/adwutil.

1. Create pkg/adwutil/errors.go:

Copy content from internal/async/errors.go, change package to `adwutil`:

```go
// Package adwutil provides reusable GTK4/Libadwaita patterns.
//
// This file defines the UserError type for structured user-friendly error handling.
package adwutil

import "fmt"

// UserError wraps an error with user-friendly messaging.
//
// It separates the user-facing summary from technical details, enabling:
//   - Clear, actionable error messages for users
//   - Preserved technical details for debugging and logging
//   - Expandable details view in the UI
//
// Tone guidelines:
//   - Use "Couldn't" not "Failed to" or "Error:"
//   - Keep summaries short and action-oriented
//   - Include hints only when actionable
//
// Example:
//
//    return &adwutil.UserError{
//        Summary:   "Couldn't install Firefox",
//        Hint:      "Check your internet connection",
//        Technical: err,
//    }
type UserError struct {
    // Summary is the user-facing message: "Couldn't install Firefox"
    Summary string

    // Hint is an optional action suggestion: "Check your internet connection"
    Hint string

    // Technical is the original error for logging and debugging.
    Technical error
}

// Error returns the user-facing summary, satisfying the error interface.
func (e *UserError) Error() string {
    return e.Summary
}

// Unwrap returns the underlying technical error, enabling errors.Is/As.
func (e *UserError) Unwrap() error {
    return e.Technical
}

// FormatForUser returns the display message without technical details.
func (e *UserError) FormatForUser() string {
    if e.Hint != "" {
        return fmt.Sprintf("%s: %s", e.Summary, e.Hint)
    }
    return e.Summary
}

// FormatWithDetails returns the user message plus technical details.
func (e *UserError) FormatWithDetails() string {
    userMsg := e.FormatForUser()
    if e.Technical != nil {
        return fmt.Sprintf("%s\n\nDetails: %v", userMsg, e.Technical)
    }
    return userMsg
}

// NewUserError creates a UserError with just a summary and technical error.
func NewUserError(summary string, technical error) *UserError {
    return &UserError{
        Summary:   summary,
        Technical: technical,
    }
}

// NewUserErrorWithHint creates a UserError with summary, hint, and technical error.
func NewUserErrorWithHint(summary, hint string, technical error) *UserError {
    return &UserError{
        Summary:   summary,
        Hint:      hint,
        Technical: technical,
    }
}
```

2. Create pkg/adwutil/errors_test.go:

Copy tests from internal/async/errors_test.go (from 09-02), update package:

```go
package adwutil

import (
    "errors"
    "strings"
    "testing"
)

// Copy all test functions from internal/async/errors_test.go
// Change package declaration only
```

IMPORTANT: Only imports in errors.go: fmt
  </action>
  <verify>go test -v ./pkg/adwutil/...</verify>
  <done>UserError extracted to adwutil, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Update internal/async to re-export from adwutil</name>
  <files>
internal/async/scheduler.go
internal/async/errors.go
  </files>
  <action>
Update internal/async to re-export from pkg/adwutil.

This maintains backward compatibility - existing code using internal/async continues to work.

1. Update internal/async/scheduler.go:

```go
// Package async provides thread-safe utilities for goroutine-to-UI communication
// in GTK4 applications using puregotk.
//
// This package re-exports functionality from pkg/adwutil for backward compatibility.
// New code should import pkg/adwutil directly.
package async

import "github.com/frostyard/chairlift/pkg/adwutil"

// RunOnMain schedules a function to run on the GTK main thread.
//
// See [adwutil.RunOnMain] for full documentation.
func RunOnMain(fn func()) {
    adwutil.RunOnMain(fn)
}
```

2. Update internal/async/errors.go:

```go
// Package async provides thread-safe utilities for goroutine-to-UI communication.
//
// This file re-exports UserError from pkg/adwutil for backward compatibility.
package async

import "github.com/frostyard/chairlift/pkg/adwutil"

// UserError is an alias for [adwutil.UserError].
// New code should use adwutil.UserError directly.
type UserError = adwutil.UserError

// NewUserError creates a UserError with just a summary and technical error.
// See [adwutil.NewUserError] for full documentation.
func NewUserError(summary string, technical error) *UserError {
    return adwutil.NewUserError(summary, technical)
}

// NewUserErrorWithHint creates a UserError with summary, hint, and technical error.
// See [adwutil.NewUserErrorWithHint] for full documentation.
func NewUserErrorWithHint(summary, hint string, technical error) *UserError {
    return adwutil.NewUserErrorWithHint(summary, hint, technical)
}
```

3. Delete internal/async/errors_test.go if it exists (tests now live in pkg/adwutil)
   Or keep it as a compatibility test that verifies the re-exports work.
  </action>
  <verify>go test -v ./internal/async/... && go build ./...</verify>
  <done>internal/async re-exports from adwutil, full application compiles</done>
</task>

</tasks>

<verification>
Verify library has no internal imports:
```bash
go list -f '{{.Imports}}' ./pkg/adwutil/... | grep -v "frostyard/chairlift/internal" || echo "Clean - no internal imports"
```

Run all tests:
```bash
go test -v ./pkg/adwutil/... ./internal/async/...
```

Verify full application compiles:
```bash
go build ./...
```
</verification>

<success_criteria>
- pkg/adwutil exists with doc.go, async.go, errors.go
- pkg/adwutil has NO imports from internal/ packages
- pkg/adwutil tests pass
- internal/async re-exports from adwutil
- Full application compiles and runs
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing-library/09-03-SUMMARY.md`
</output>
