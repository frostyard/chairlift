---
phase: 09-testing-library
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/pm/wrapper.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Flatpak applications section correctly distinguishes user vs system flatpaks"
    - "Debug logging reveals actual Namespace values from pm library"
  artifacts:
    - path: "internal/pm/wrapper.go"
      provides: "Debug logging for Namespace values"
      contains: "Namespace"
  key_links:
    - from: "internal/pm/wrapper.go"
      to: "internal/pages/applications/page.go"
      via: "FlatpakApplication.IsUser field"
      pattern: "IsUser"
---

<objective>
Investigate and fix flatpak user/system classification issue

Purpose: Close UAT gap - flatpak applications section shows all applications as system flatpaks, but many should be user flatpaks. Root cause investigation needed.
Output: Either a fix in wrapper.go or documented upstream issue
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/pm/wrapper.go
@internal/pages/applications/page.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug logging to ListFlatpakApplications</name>
  <files>internal/pm/wrapper.go</files>
  <action>
Add debug logging to ListFlatpakApplications() to understand what Namespace values the pm library returns.

In the loop that processes installed packages (around line 155), add logging:

```go
for _, pkg := range installed {
    // Debug: log the raw Namespace value from pm library
    log.Printf("[DEBUG] Flatpak app: %s, Namespace='%s', Kind=%s",
        pkg.Ref.Name, pkg.Ref.Namespace, pkg.Ref.Kind)

    isUser := pkg.Ref.Namespace == "user"
    // ... rest of existing code
}
```

This will reveal:
1. Whether Namespace is populated at all
2. What exact string values Namespace contains
3. Whether the issue is empty Namespace, wrong values, or something else

After testing, this logging can be removed or made conditional on a debug flag.
  </action>
  <verify>
- `go build ./cmd/chairlift` - compiles successfully
- `grep "DEBUG.*Namespace" internal/pm/wrapper.go` - debug logging present
  </verify>
  <done>Debug logging added to reveal Namespace values</done>
</task>

<task type="auto">
  <name>Task 2: Test and diagnose the issue</name>
  <files>internal/pm/wrapper.go</files>
  <action>
Run the application and check the debug output to understand the root cause.

```bash
# Build and run with logging visible
go build -o /tmp/chairlift-test ./cmd/chairlift && /tmp/chairlift-test 2>&1 | grep -i "DEBUG.*flatpak\|Namespace"
```

Based on the debug output, determine:

**Scenario A: Namespace is populated correctly**
- If Namespace shows "user" and "system" correctly, the issue is elsewhere
- Check applications/page.go logic more carefully

**Scenario B: Namespace is empty or incorrect**
- This is an upstream pm library issue
- The pm library's flatpak.go parses `flatpak list --app --columns=name,application,version,installation`
- If tabs vs spaces parsing fails, Namespace won't be populated

**Scenario C: Fallback parsing path**
- The pm library has fallback parsing (lines 420-451 in flatpak.go) that may not capture Namespace

Based on findings:

If UPSTREAM ISSUE:
1. Document the finding in the SUMMARY
2. Remove or make debug logging conditional
3. Note that fix should be in github.com/frostyard/pm, not chairlift
4. Keep current behavior (apps default to system if Namespace unknown)

If CHAIRLIFT ISSUE:
1. Fix the logic in wrapper.go or page.go
2. Remove debug logging
3. Verify the fix works
  </action>
  <verify>
Test the application:
- `go build -o /tmp/chairlift-test ./cmd/chairlift`
- Run and observe debug output OR document findings
- Check that the investigation is complete
  </verify>
  <done>Root cause identified and either fixed in chairlift or documented as upstream issue</done>
</task>

<task type="auto">
  <name>Task 3: Clean up and finalize</name>
  <files>internal/pm/wrapper.go</files>
  <action>
Based on Task 2 findings:

**If upstream issue confirmed:**
1. Remove or comment out the DEBUG logging (it's too verbose for production)
2. Add a TODO comment explaining the issue:
   ```go
   // TODO: Namespace may be empty if pm library parsing fails.
   // See: upstream pm library flatpak backend parsing.
   // Apps with empty Namespace default to system (IsUser=false).
   ```

**If fixed in chairlift:**
1. Remove DEBUG logging
2. Ensure fix is clean and minimal

Either way:
- Ensure `go build ./cmd/chairlift` succeeds
- Code is production-ready (no debug spam)
  </action>
  <verify>
- `go build ./cmd/chairlift` - compiles
- No DEBUG logging spam in production code (either removed or behind flag)
- Issue is either fixed or documented for upstream
  </verify>
  <done>Code is clean and issue is resolved or documented</done>
</task>

</tasks>

<verification>
- `go build ./cmd/chairlift` - application compiles
- Debug logging is removed or conditional
- Issue is either fixed OR documented as upstream pm library issue
- Applications page still functions correctly
</verification>

<success_criteria>
- Root cause of user/system misclassification is identified
- Either: Fix applied to chairlift code
- Or: Issue documented as upstream pm library problem with TODO comment
- Production code is clean (no verbose debug logging)
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing-library/09-07-SUMMARY.md`

Include in summary:
- Root cause finding (upstream vs chairlift)
- What Namespace values were observed
- Resolution (fix or documentation)
- Whether upstream issue should be filed
</output>
