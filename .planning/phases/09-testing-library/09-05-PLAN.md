---
phase: 09-testing-library
plan: 05
type: execute
wave: 4
depends_on: ["09-04"]
files_modified:
  - pkg/adwutil/README.md
  - pkg/adwutil/examples/basic/main.go
  - pkg/adwutil/examples/operations/main.go
autonomous: true

must_haves:
  truths:
    - "Library has README.md with usage documentation"
    - "Basic example demonstrates RunOnMain and widgets"
    - "Operations example demonstrates async operation tracking"
    - "Examples are buildable and runnable"
  artifacts:
    - path: "pkg/adwutil/README.md"
      provides: "Library documentation with quick start"
      min_lines: 100
    - path: "pkg/adwutil/examples/basic/main.go"
      provides: "Basic usage example"
      min_lines: 50
    - path: "pkg/adwutil/examples/operations/main.go"
      provides: "Operations tracking example"
      min_lines: 80
  key_links:
    - from: "pkg/adwutil/README.md"
      to: "pkg/adwutil/examples/"
      via: "example references"
      pattern: "examples/"
---

<objective>
Add documentation and working example applications for the adwutil library.

Purpose: Make the library usable by other developers by providing clear documentation and runnable examples that demonstrate patterns in context.
Output: README.md with usage docs, two working example mini-apps.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-testing-library/09-CONTEXT.md
@.planning/phases/09-testing-library/09-RESEARCH.md

Prior plan summary:
@.planning/phases/09-testing-library/09-04-SUMMARY.md

Library source (for accurate documentation):
@pkg/adwutil/doc.go
@pkg/adwutil/async.go
@pkg/adwutil/errors.go
@pkg/adwutil/widgets.go
@pkg/adwutil/operations.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create README.md documentation</name>
  <files>pkg/adwutil/README.md</files>
  <action>
Create comprehensive README.md for the adwutil library.

```markdown
# adwutil

Reusable GTK4/Libadwaita patterns for Go applications.

This library extracts common patterns from [ChairLift](https://github.com/frostyard/chairlift) into a reusable toolkit for building GTK4/Libadwaita applications with pure Go (via [puregotk](https://github.com/jwijenbergh/puregotk)).

## Features

- **Thread-safe async utilities** - Safe goroutine-to-UI communication with `RunOnMain`
- **User-friendly error handling** - `UserError` type separates user messages from technical details
- **Widget helpers** - Common patterns for ActionRows, empty states, and more
- **Operations tracking** - Track, cancel, and display progress of async operations

## Installation

```bash
go get github.com/frostyard/chairlift/pkg/adwutil
```

## Quick Start

### Thread-Safe UI Updates

GTK is not thread-safe. Use `RunOnMain` to update UI from goroutines:

```go
import "github.com/frostyard/chairlift/pkg/adwutil"

go func() {
    result := doExpensiveWork()
    adwutil.RunOnMain(func() {
        label.SetText(result)
    })
}()
```

### User-Friendly Errors

Create errors that show users clear messages while preserving technical details:

```go
err := adwutil.NewUserErrorWithHint(
    "Couldn't install Firefox",
    "Check your internet connection",
    technicalErr,
)

// For UI display
message := err.FormatForUser()  // "Couldn't install Firefox: Check your internet connection"

// For logging
details := err.FormatWithDetails()  // Includes technical error
```

### Widget Helpers

Create common widget patterns with less boilerplate:

```go
// Empty state placeholder
emptyState := adwutil.NewEmptyState(adwutil.EmptyStateConfig{
    Title:       "No Items",
    Description: "Items will appear here when added",
    IconName:    "folder-symbolic",
})

// Row with action button
row := adwutil.NewButtonRow(
    "Firefox",
    "Web browser",
    "Install",
    func() { installApp("firefox") },
)

// Link row (opens URL or app)
link := adwutil.NewLinkRow(
    "Documentation",
    "https://docs.example.com",
    func() { openURL("https://docs.example.com") },
)
```

### Operations Tracking

Track long-running operations with progress and cancellation:

```go
// Start a tracked operation
op := adwutil.Start("Installing Firefox", adwutil.CategoryInstall, true)

go func() {
    err := install("firefox")
    adwutil.RunOnMain(func() {
        op.Complete(err)
    })
}()

// Update progress (from goroutine)
adwutil.RunOnMain(func() {
    op.UpdateProgress(0.5, "Downloading...")
})

// Cancel operation
op.Cancel()

// Listen for operation changes
adwutil.AddListener(func(op *adwutil.Operation) {
    updateUI(op)
})
```

## Examples

See the [examples](./examples/) directory for complete working applications:

- [`basic`](./examples/basic/) - Demonstrates RunOnMain, widgets, and error handling
- [`operations`](./examples/operations/) - Demonstrates async operation tracking with progress

Run examples:

```bash
cd pkg/adwutil/examples/basic
go run main.go
```

## API Reference

See [pkg.go.dev documentation](https://pkg.go.dev/github.com/frostyard/chairlift/pkg/adwutil) for full API reference.

### Key Types

| Type | Description |
|------|-------------|
| `UserError` | User-friendly error with summary, hint, and technical details |
| `EmptyStateConfig` | Configuration for empty state displays |
| `Operation` | Tracked async operation with progress and cancellation |
| `Registry` | Operations registry (singleton available via package functions) |
| `Category` | Operation category (Install, Update, Remove, Maintenance) |
| `State` | Operation state (Active, Completed, Failed, Cancelled) |

### Key Functions

| Function | Description |
|----------|-------------|
| `RunOnMain(fn)` | Schedule function to run on GTK main thread |
| `NewUserError(summary, err)` | Create user error without hint |
| `NewUserErrorWithHint(summary, hint, err)` | Create user error with hint |
| `NewEmptyState(cfg)` | Create empty state StatusPage |
| `NewButtonRow(title, subtitle, label, onClick)` | Create row with action button |
| `NewLinkRow(title, subtitle, onClick)` | Create row with link icon |
| `Start(name, category, cancellable)` | Start tracked operation |

## Design Philosophy

### Error Tone

Error messages follow GNOME HIG guidelines:
- Use "Couldn't" not "Failed to" or "Error:"
- Keep summaries short and action-oriented
- Include hints only when actionable

### Thread Safety

All widget operations must happen on the GTK main thread. The `RunOnMain` function provides a safe way to schedule UI updates from goroutines while preventing callback garbage collection.

### Callback Registry

Signal callbacks passed to GTK widget methods are stored in a registry to prevent Go's garbage collector from collecting them before the signals fire.

## Requirements

- Go 1.22+
- GTK4 and Libadwaita installed
- puregotk v4

## License

MIT License - see [LICENSE](../../LICENSE)
```
  </action>
  <verify>cat pkg/adwutil/README.md | head -20</verify>
  <done>README.md created with usage documentation and API reference</done>
</task>

<task type="auto">
  <name>Task 2: Create basic example application</name>
  <files>pkg/adwutil/examples/basic/main.go</files>
  <action>
Create a basic example demonstrating RunOnMain, widgets, and error handling.

Create the directory structure first, then the file:

```go
// Example: basic
//
// Demonstrates basic adwutil usage: RunOnMain, widgets, and error handling.
//
// Run with: go run main.go
package main

import (
    "fmt"
    "os"
    "time"

    "github.com/frostyard/chairlift/pkg/adwutil"
    "github.com/jwijenbergh/puregotk/v4/adw"
    "github.com/jwijenbergh/puregotk/v4/gio"
    "github.com/jwijenbergh/puregotk/v4/gtk"
)

func main() {
    app := adw.NewApplication("com.example.AdwutilBasic", gio.GApplicationFlagsNoneValue)

    onActivate := func(_ gio.Application) {
        activate(app)
    }
    app.ConnectActivate(&onActivate)

    if code := app.Run(len(os.Args), os.Args); code > 0 {
        os.Exit(code)
    }
}

func activate(app *adw.Application) {
    window := adw.NewApplicationWindow(&app.Application)
    window.SetTitle("adwutil Basic Example")
    window.SetDefaultSize(400, 300)

    // Create main content
    box := gtk.NewBox(gtk.OrientationVerticalValue, 12)
    box.SetMarginTop(24)
    box.SetMarginBottom(24)
    box.SetMarginStart(24)
    box.SetMarginEnd(24)

    // Status label
    statusLabel := gtk.NewLabel("Ready")
    statusLabel.AddCssClass("title-2")
    box.Append(&statusLabel.Widget)

    // Preferences group with widget examples
    group := adw.NewPreferencesGroup()
    group.SetTitle("Widget Examples")

    // Button row - demonstrates NewButtonRow
    row1 := adwutil.NewButtonRow(
        "Async Operation",
        "Click to start a background task",
        "Start",
        func() {
            statusLabel.SetText("Starting...")
            go func() {
                // Simulate work
                time.Sleep(2 * time.Second)

                // Update UI safely from goroutine
                adwutil.RunOnMain(func() {
                    statusLabel.SetText("Completed!")
                })
            }()
        },
    )
    group.Add(&row1.Widget)

    // Link row - demonstrates NewLinkRow
    row2 := adwutil.NewLinkRow(
        "Documentation",
        "View adwutil docs on GitHub",
        func() {
            fmt.Println("Would open: https://github.com/frostyard/chairlift/tree/main/pkg/adwutil")
        },
    )
    group.Add(&row2.Widget)

    // Info row - demonstrates NewInfoRow
    row3 := adwutil.NewInfoRow("Version", "1.0.0")
    group.Add(&row3.Widget)

    // Icon row - demonstrates NewIconRow
    row4 := adwutil.NewIconRow("Status", "All systems operational", "object-select-symbolic")
    group.Add(&row4.Widget)

    box.Append(&group.Widget)

    // Error handling example
    errGroup := adw.NewPreferencesGroup()
    errGroup.SetTitle("Error Handling")

    errRow := adwutil.NewButtonRow(
        "Simulate Error",
        "Demonstrates UserError formatting",
        "Trigger",
        func() {
            // Create a user-friendly error
            err := adwutil.NewUserErrorWithHint(
                "Couldn't complete operation",
                "Try again in a few moments",
                fmt.Errorf("network timeout after 30s"),
            )

            // Show user message
            statusLabel.SetText(err.FormatForUser())

            // Technical details available for logging
            fmt.Println("Technical:", err.FormatWithDetails())
        },
    )
    errGroup.Add(&errRow.Widget)

    box.Append(&errGroup.Widget)

    // Empty state example
    emptyGroup := adw.NewPreferencesGroup()
    emptyGroup.SetTitle("Empty State")

    emptyState := adwutil.NewEmptyState(adwutil.EmptyStateConfig{
        Title:       "No Items",
        Description: "Items will appear here when added",
        IconName:    "folder-symbolic",
        Compact:     true,
    })
    emptyGroup.Add(&emptyState.Widget)

    box.Append(&emptyGroup.Widget)

    // Wrap in scrolled window
    scrolled := gtk.NewScrolledWindow()
    scrolled.SetChild(&box.Widget)

    // Wrap in toolbar view
    toolbarView := adw.NewToolbarView()
    headerBar := adw.NewHeaderBar()
    toolbarView.AddTopBar(&headerBar.Widget)
    toolbarView.SetContent(&scrolled.Widget)

    window.SetContent(&toolbarView.Widget)
    window.Present()
}
```

Create directories: `mkdir -p pkg/adwutil/examples/basic`
  </action>
  <verify>go build ./pkg/adwutil/examples/basic/...</verify>
  <done>Basic example compiles and demonstrates core adwutil features</done>
</task>

<task type="auto">
  <name>Task 3: Create operations example application</name>
  <files>pkg/adwutil/examples/operations/main.go</files>
  <action>
Create an operations example demonstrating async operation tracking.

```go
// Example: operations
//
// Demonstrates adwutil operations tracking: starting, progress, completion, cancellation.
//
// Run with: go run main.go
package main

import (
    "context"
    "fmt"
    "os"
    "time"

    "github.com/frostyard/chairlift/pkg/adwutil"
    "github.com/jwijenbergh/puregotk/v4/adw"
    "github.com/jwijenbergh/puregotk/v4/gio"
    "github.com/jwijenbergh/puregotk/v4/gtk"
)

var (
    activeLabel *gtk.Label
    historyBox  *gtk.Box
)

func main() {
    app := adw.NewApplication("com.example.AdwutilOperations", gio.GApplicationFlagsNoneValue)

    onActivate := func(_ gio.Application) {
        activate(app)
    }
    app.ConnectActivate(&onActivate)

    if code := app.Run(len(os.Args), os.Args); code > 0 {
        os.Exit(code)
    }
}

func activate(app *adw.Application) {
    window := adw.NewApplicationWindow(&app.Application)
    window.SetTitle("adwutil Operations Example")
    window.SetDefaultSize(500, 400)

    // Listen for operation updates
    adwutil.AddListener(onOperationUpdate)

    // Create main layout
    mainBox := gtk.NewBox(gtk.OrientationVerticalValue, 12)
    mainBox.SetMarginTop(24)
    mainBox.SetMarginBottom(24)
    mainBox.SetMarginStart(24)
    mainBox.SetMarginEnd(24)

    // Active operations counter
    activeLabel = gtk.NewLabel("Active operations: 0")
    activeLabel.AddCssClass("title-3")
    mainBox.Append(&activeLabel.Widget)

    // Actions group
    actionsGroup := adw.NewPreferencesGroup()
    actionsGroup.SetTitle("Start Operations")

    // Simple operation
    row1 := adwutil.NewButtonRow(
        "Quick Task",
        "Completes in 2 seconds",
        "Start",
        func() {
            startSimpleOperation("Quick Task", 2*time.Second)
        },
    )
    actionsGroup.Add(&row1.Widget)

    // Operation with progress
    row2 := adwutil.NewButtonRow(
        "Download Simulation",
        "Shows progress updates",
        "Start",
        func() {
            startProgressOperation()
        },
    )
    actionsGroup.Add(&row2.Widget)

    // Cancellable operation
    row3 := adwutil.NewButtonRow(
        "Long Task (Cancellable)",
        "Can be cancelled after 5 seconds",
        "Start",
        func() {
            startCancellableOperation()
        },
    )
    actionsGroup.Add(&row3.Widget)

    // Failing operation
    row4 := adwutil.NewButtonRowWithClass(
        "Failing Task",
        "Will fail after 1 second",
        "Start",
        "destructive-action",
        func() {
            startFailingOperation()
        },
    )
    actionsGroup.Add(&row4.Widget)

    mainBox.Append(&actionsGroup.Widget)

    // History group
    historyGroup := adw.NewPreferencesGroup()
    historyGroup.SetTitle("Operation History")

    historyBox = gtk.NewBox(gtk.OrientationVerticalValue, 6)
    historyLabel := gtk.NewLabel("Completed operations will appear here")
    historyLabel.AddCssClass("dim-label")
    historyBox.Append(&historyLabel.Widget)

    historyGroup.Add(&historyBox.Widget)
    mainBox.Append(&historyGroup.Widget)

    // Wrap in scrolled window
    scrolled := gtk.NewScrolledWindow()
    scrolled.SetChild(&mainBox.Widget)

    // Wrap in toolbar view
    toolbarView := adw.NewToolbarView()
    headerBar := adw.NewHeaderBar()
    toolbarView.AddTopBar(&headerBar.Widget)
    toolbarView.SetContent(&scrolled.Widget)

    window.SetContent(&toolbarView.Widget)
    window.Present()
}

func startSimpleOperation(name string, duration time.Duration) {
    op := adwutil.Start(name, adwutil.CategoryMaintenance, false)

    go func() {
        time.Sleep(duration)
        adwutil.RunOnMain(func() {
            op.Complete(nil)
        })
    }()
}

func startProgressOperation() {
    op := adwutil.Start("Downloading...", adwutil.CategoryInstall, false)

    go func() {
        for i := 0; i <= 10; i++ {
            progress := float64(i) / 10.0
            message := fmt.Sprintf("Downloaded %d%%", i*10)

            adwutil.RunOnMain(func() {
                op.UpdateProgress(progress, message)
            })

            time.Sleep(300 * time.Millisecond)
        }

        adwutil.RunOnMain(func() {
            op.Complete(nil)
        })
    }()
}

func startCancellableOperation() {
    op, ctx := adwutil.StartWithContext(context.Background(), "Long Task", adwutil.CategoryUpdate)

    go func() {
        select {
        case <-time.After(30 * time.Second):
            adwutil.RunOnMain(func() {
                op.Complete(nil)
            })
        case <-ctx.Done():
            // Operation was cancelled
            fmt.Println("Operation cancelled!")
        }
    }()

    // After 6 seconds, cancel it (demonstrating cancellation)
    go func() {
        time.Sleep(6 * time.Second)
        adwutil.RunOnMain(func() {
            if op.IsCancellable() {
                fmt.Println("Cancelling operation...")
                op.Cancel()
            }
        })
    }()
}

func startFailingOperation() {
    op := adwutil.Start("Failing Task", adwutil.CategoryInstall, false)

    go func() {
        time.Sleep(1 * time.Second)

        err := adwutil.NewUserErrorWithHint(
            "Couldn't complete task",
            "This is a simulated failure",
            fmt.Errorf("simulated error"),
        )

        adwutil.RunOnMain(func() {
            op.Complete(err)
        })
    }()
}

func onOperationUpdate(op *adwutil.Operation) {
    // Update active count
    count := adwutil.ActiveCount()
    activeLabel.SetText(fmt.Sprintf("Active operations: %d", count))

    // Add to history if completed/failed/cancelled
    if op.State != adwutil.StateActive {
        addToHistory(op)
    }
}

func addToHistory(op *adwutil.Operation) {
    stateStr := "?"
    iconName := "object-select-symbolic"

    switch op.State {
    case adwutil.StateCompleted:
        stateStr = "Completed"
        iconName = "object-select-symbolic"
    case adwutil.StateFailed:
        stateStr = "Failed"
        iconName = "dialog-error-symbolic"
    case adwutil.StateCancelled:
        stateStr = "Cancelled"
        iconName = "process-stop-symbolic"
    }

    row := adwutil.NewIconRow(
        op.Name,
        fmt.Sprintf("%s in %v", stateStr, op.Duration().Round(time.Millisecond)),
        iconName,
    )

    historyBox.Prepend(&row.Widget)
}
```

Create directories: `mkdir -p pkg/adwutil/examples/operations`
  </action>
  <verify>go build ./pkg/adwutil/examples/operations/...</verify>
  <done>Operations example compiles and demonstrates operation tracking features</done>
</task>

</tasks>

<verification>
Build all examples:
```bash
go build ./pkg/adwutil/examples/...
```

Verify README renders correctly:
```bash
head -50 pkg/adwutil/README.md
```

List complete library structure:
```bash
find pkg/adwutil -type f -name "*.go" -o -name "*.md"
```
</verification>

<success_criteria>
- README.md exists with clear usage documentation
- Basic example compiles and shows widgets + async
- Operations example compiles and shows operation tracking
- Examples directory structure follows Go conventions
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing-library/09-05-SUMMARY.md`
</output>
